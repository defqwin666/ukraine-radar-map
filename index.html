<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ukraine Radar Map ‚Äî –ª–æ–∫–∞–ª—å–Ω–∞ –∫–æ–ø—ñ—è (–±–µ–∑ –≤—Ö–æ–¥—É)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
// === City search (Nominatim) ===
(function(){
  const inp = $("citySearch"), box = $("cityResults");
  if(!inp || !box) return;
  let tmr=null, lastQ="";
  const show = (items)=>{
    box.innerHTML = items.map(it=>`
      <div class="item" data-lat="${it.lat}" data-lon="${it.lon}">
        <b>${escapeHtml(it.name)}</b>
        <span class="small">${escapeHtml(it.desc||"")}</span>
      </div>`).join("");
    box.style.display = items.length ? "block" : "none";
  };
  inp.addEventListener("input", ()=>{
    const q = inp.value.trim();
    if(q===lastQ) return;
    lastQ=q;
    if(tmr) clearTimeout(tmr);
    if(!q){ box.style.display="none"; return; }
    tmr=setTimeout(async ()=>{
      try{
        const url = "https://nominatim.openstreetmap.org/search?format=json&limit=8&addressdetails=1&q="+encodeURIComponent(q+" –£–∫—Ä–∞—ó–Ω–∞");
        const r = await fetch(url, { headers: { "Accept-Language":"uk" } });
        const j = await r.json();
        const items = (j||[]).map(x=>({
          lat: x.lat, lon: x.lon,
          name: (x.display_name||"").split(",")[0],
          desc: x.display_name || ""
        }));
        show(items);
      }catch(e){
        show([{lat:"",lon:"",name:"–ù–µ–º–∞—î —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É / –ø–æ—à—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π",desc:""}]);
      }
    }, 350);
  });
  box.addEventListener("click", (e)=>{
    const el = e.target.closest(".item");
    if(!el) return;
    const lat = parseFloat(el.dataset.lat), lon = parseFloat(el.dataset.lon);
    if(!isFinite(lat)||!isFinite(lon)) return;
    map.setView([lat,lon], 11);
    box.style.display="none";
  });
})();

// === Oblast selection: dim unselected ===
function applyOblastStyles(){
  if(!oblastLayer) return;
  const sel = new Set((state.selOblasts||[]).map(s=>s.toLowerCase()));
  oblastLayer.eachLayer(l=>{
    const nm = (l.feature?.properties?.name || l.feature?.properties?.NAME_1 || l.feature?.properties?.NAME || "").toString();
    const key = nm.toLowerCase();
    const chosen = sel.size===0 || sel.has(key);
    l.setStyle({
      color: state.oblastStroke || "#00aaff",
      weight: 1.2,
      fillColor: chosen ? "#000000" : "#000000",
      fillOpacity: chosen ? 0.0 : 0.7,
      opacity: 0.95
    });
  });
}
function syncOblastSelectFromSet(){
  const el = $("oblastSelect"); if(!el) return;
  const want = new Set((state.selOblasts||[]).map(s=>s.toLowerCase()));
  for(const opt of el.options){
    opt.selected = want.has(opt.value.toLowerCase());
  }
}
$("oblastSelect")?.addEventListener("change", ()=>{
  const el = $("oblastSelect");
  state.selOblasts = [...el.selectedOptions].map(o=>o.value);
  save();
  applyOblastStyles();
});
$("btnOblastReset")?.addEventListener("click", ()=>{
  state.selOblasts = [];
  save();
  syncOblastSelectFromSet();
  applyOblastStyles();
});

// Hook oblast clicks to toggle selection (when layer loaded)
function hookOblastClicks(){
  if(!oblastLayer) return;
  oblastLayer.eachLayer(l=>{
    l.off("click");
    l.on("click", ()=>{
      const nm = (l.feature?.properties?.name || l.feature?.properties?.NAME_1 || l.feature?.properties?.NAME || "").toString();
      if(!nm) return;
      const cur = new Set((state.selOblasts||[]));
      if(cur.has(nm)) cur.delete(nm); else cur.add(nm);
      state.selOblasts = [...cur];
      save();
      syncOblastSelectFromSet();
      applyOblastStyles();
    });
  });
}

// === Points (avatar-style markers) ===
state.points = state.points || [];
let pointMode=false;
function pointIconHTML(p){
  const label = escapeHtml(p.name||"");
  const kind = p.iconKind || "M";
  let inner = "";
  if(kind==="img" && p.img){
    inner = `<img src="${escapeHtml(p.img)}" alt="">`;
  }else if(kind==="pin"){
    inner = `<div style="font-size:18px;">üìç</div>`;
  }else{
    const ch = (label.trim()[0] || "‚Ä¢").toUpperCase();
    inner = `<div style="font-weight:900;">${escapeHtml(ch)}</div>`;
  }
  return `<div style="display:flex;flex-direction:column;align-items:center;">
    <div class="avatarMarker">${inner}</div>
    <div class="avatarLabel">${label}</div>
  </div>`;
}
function renderPoints(){
  if(!window.pointsLayer){
    window.pointsLayer = L.layerGroup().addTo(map);
  }
  window.pointsLayer.clearLayers();
  for(const p of (state.points||[])){
    const icon = L.divIcon({ className:"", html: pointIconHTML(p), iconSize:[60,60], iconAnchor:[30,30] });
    const m = L.marker([p.lat,p.lng], { icon }).addTo(window.pointsLayer);
    m.on("contextmenu", ()=>{
      if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ—á–∫—É '"+(p.name||"")+"'?")){
        state.points = (state.points||[]).filter(x=>x.id!==p.id);
        save();
        renderPoints();
      }
    });
  }
}
$("ptMode")?.addEventListener("click", ()=>{
  pointMode = !pointMode;
  $("ptMode").textContent = "üìç –†–µ–∂–∏–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏: " + (pointMode?"–£–≤—ñ–º–∫":"–í–∏–º–∫");
});
$("ptClear")?.addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ç–æ—á–∫–∏?")){
    state.points = [];
    save();
    renderPoints();
  }
});
document.querySelectorAll("[data-pt-example]")?.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $("ptName").value = btn.getAttribute("data-pt-example") || "";
  });
});
map.on("click", (e)=>{
  if(!pointMode) return;
  const name = ($("ptName")?.value || "").trim() || "–¢–æ—á–∫–∞";
  const iconKind = ($("ptIcon")?.value || "M");
  const img = ($("ptImg")?.value || "").trim();
  const p = { id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()), name, iconKind, img, lat:e.latlng.lat, lng:e.latlng.lng };
  state.points.push(p);
  save();
  renderPoints();
});
renderPoints();


// === Oblast toggles list (alphabet UA) ===
const OBLASTS_UA = [
  "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º",
  "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–õ—É–≥–∞–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–°—É–º—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å"
];
function normOblastName(n){
  n = (n||"").toString().trim();
  // unify common variants from geojson
  n = n.replace(/^–º\.\s*/i,"").replace(/\s+–æ–±–ª\.?$/i," –æ–±–ª–∞—Å—Ç—å");
  if(n.toLowerCase()==="–∫—Ä–∏–º" || n.toLowerCase().includes("–∫—Ä–∏–º")) return "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º";
  if(!/–æ–±–ª–∞—Å—Ç—å$/i.test(n) && !n.toLowerCase().includes("—Ä–µ—Å–ø—É–±–ª—ñ–∫–∞")) n += " –æ–±–ª–∞—Å—Ç—å";
  return n;
}
function renderOblastToggleList(){
  const box = $("oblastToggleList");
  if(!box) return;
  const sel = new Set((state.selOblasts||[]).map(normOblastName));
  box.innerHTML = OBLASTS_UA.map(name=>{
    const on = sel.size===0 ? false : sel.has(name);
    return `
      <div class="row" style="justify-content:space-between;gap:10px;">
        <div style="font-weight:700;">${escapeHtml(name)}</div>
        <div class="switch ${on?'on':''}" data-oblast="${escapeHtml(name)}"></div>
      </div>`;
  }).join("");
  box.querySelectorAll(".switch[data-oblast]").forEach(sw=>{
    sw.addEventListener("click", ()=>{
      const name = sw.getAttribute("data-oblast");
      const cur = new Set((state.selOblasts||[]).map(normOblastName));
      // if empty selection means "none selected" in UI; we will start selection set on first toggle
      if(cur.size===0){
        cur.add(name);
      } else {
        if(cur.has(name)) cur.delete(name); else cur.add(name);
      }
      state.selOblasts = [...cur];
      save();
      renderOblastToggleList();
      syncOblastSelectFromSet?.();
      applyOblastStyles?.();
    });
  });
}
$("oblastAll")?.addEventListener("click", ()=>{
  state.selOblasts = [...OBLASTS_UA];
  save(); renderOblastToggleList(); syncOblastSelectFromSet?.(); applyOblastStyles?.();
});
$("oblastNone")?.addEventListener("click", ()=>{
  state.selOblasts = [];
  save(); renderOblastToggleList(); syncOblastSelectFromSet?.(); applyOblastStyles?.();
});
// re-render when settings tab opened
document.querySelectorAll("[data-tab]")?.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    if(btn.getAttribute("data-tab")==="settings"){
      setTimeout(()=>renderOblastToggleList(), 50);
    }
  });
});

</script>

  <!-- html2canvas (—Å–∫—Ä—ñ–Ω—à–æ—Ç) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js">
let isDark=false;
$("toggleMapTheme")?.addEventListener("click",()=>{
 if(!isDark){ if(typeof lightLayer!=="undefined") map.removeLayer(lightLayer); if(typeof darkLayer!=="undefined") darkLayer.addTo(map); $("toggleMapTheme").textContent="–°–≤—ñ—Ç–ª–∞ –º–∞–ø–∞"; }
 else{ if(typeof darkLayer!=="undefined") map.removeLayer(darkLayer); if(typeof lightLayer!=="undefined") lightLayer.addTo(map); $("toggleMapTheme").textContent="–¢–µ–º–Ω–∞ –º–∞–ø–∞<br><label><input type='checkbox' id='toggleShaft' checked> –ü–∞–ª–∫–∞ —à–∞—Ö–µ–¥–∞</label>"; }
 isDark=!isDark;
});


// === City search (Nominatim) ===
(function(){
  const inp = $("citySearch"), box = $("cityResults");
  if(!inp || !box) return;
  let tmr=null, lastQ="";
  const show = (items)=>{
    box.innerHTML = items.map(it=>`
      <div class="item" data-lat="${it.lat}" data-lon="${it.lon}">
        <b>${escapeHtml(it.name)}</b>
        <span class="small">${escapeHtml(it.desc||"")}</span>
      </div>`).join("");
    box.style.display = items.length ? "block" : "none";
  };
  inp.addEventListener("input", ()=>{
    const q = inp.value.trim();
    if(q===lastQ) return;
    lastQ=q;
    if(tmr) clearTimeout(tmr);
    if(!q){ box.style.display="none"; return; }
    tmr=setTimeout(async ()=>{
      try{
        const url = "https://nominatim.openstreetmap.org/search?format=json&limit=8&addressdetails=1&q="+encodeURIComponent(q+" –£–∫—Ä–∞—ó–Ω–∞");
        const r = await fetch(url, { headers: { "Accept-Language":"uk" } });
        const j = await r.json();
        const items = (j||[]).map(x=>({
          lat: x.lat, lon: x.lon,
          name: (x.display_name||"").split(",")[0],
          desc: x.display_name || ""
        }));
        show(items);
      }catch(e){
        show([{lat:"",lon:"",name:"–ù–µ–º–∞—î —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É / –ø–æ—à—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π",desc:""}]);
      }
    }, 350);
  });
  box.addEventListener("click", (e)=>{
    const el = e.target.closest(".item");
    if(!el) return;
    const lat = parseFloat(el.dataset.lat), lon = parseFloat(el.dataset.lon);
    if(!isFinite(lat)||!isFinite(lon)) return;
    map.setView([lat,lon], 11);
    box.style.display="none";
  });
})();

// === Oblast selection: dim unselected ===
function applyOblastStyles(){
  if(!oblastLayer) return;
  const sel = new Set((state.selOblasts||[]).map(s=>s.toLowerCase()));
  oblastLayer.eachLayer(l=>{
    const nm = (l.feature?.properties?.name || l.feature?.properties?.NAME_1 || l.feature?.properties?.NAME || "").toString();
    const key = nm.toLowerCase();
    const chosen = sel.size===0 || sel.has(key);
    l.setStyle({
      color: state.oblastStroke || "#00aaff",
      weight: 1.2,
      fillColor: chosen ? "#000000" : "#000000",
      fillOpacity: chosen ? 0.0 : 0.7,
      opacity: 0.95
    });
  });
}
function syncOblastSelectFromSet(){
  const el = $("oblastSelect"); if(!el) return;
  const want = new Set((state.selOblasts||[]).map(s=>s.toLowerCase()));
  for(const opt of el.options){
    opt.selected = want.has(opt.value.toLowerCase());
  }
}
$("oblastSelect")?.addEventListener("change", ()=>{
  const el = $("oblastSelect");
  state.selOblasts = [...el.selectedOptions].map(o=>o.value);
  save();
  applyOblastStyles();
});
$("btnOblastReset")?.addEventListener("click", ()=>{
  state.selOblasts = [];
  save();
  syncOblastSelectFromSet();
  applyOblastStyles();
});

// Hook oblast clicks to toggle selection (when layer loaded)
function hookOblastClicks(){
  if(!oblastLayer) return;
  oblastLayer.eachLayer(l=>{
    l.off("click");
    l.on("click", ()=>{
      const nm = (l.feature?.properties?.name || l.feature?.properties?.NAME_1 || l.feature?.properties?.NAME || "").toString();
      if(!nm) return;
      const cur = new Set((state.selOblasts||[]));
      if(cur.has(nm)) cur.delete(nm); else cur.add(nm);
      state.selOblasts = [...cur];
      save();
      syncOblastSelectFromSet();
      applyOblastStyles();
    });
  });
}

// === Points (avatar-style markers) ===
state.points = state.points || [];
let pointMode=false;
function pointIconHTML(p){
  const label = escapeHtml(p.name||"");
  const kind = p.iconKind || "M";
  let inner = "";
  if(kind==="img" && p.img){
    inner = `<img src="${escapeHtml(p.img)}" alt="">`;
  }else if(kind==="pin"){
    inner = `<div style="font-size:18px;">üìç</div>`;
  }else{
    const ch = (label.trim()[0] || "‚Ä¢").toUpperCase();
    inner = `<div style="font-weight:900;">${escapeHtml(ch)}</div>`;
  }
  return `<div style="display:flex;flex-direction:column;align-items:center;">
    <div class="avatarMarker">${inner}</div>
    <div class="avatarLabel">${label}</div>
  </div>`;
}
function renderPoints(){
  if(!window.pointsLayer){
    window.pointsLayer = L.layerGroup().addTo(map);
  }
  window.pointsLayer.clearLayers();
  for(const p of (state.points||[])){
    const icon = L.divIcon({ className:"", html: pointIconHTML(p), iconSize:[60,60], iconAnchor:[30,30] });
    const m = L.marker([p.lat,p.lng], { icon }).addTo(window.pointsLayer);
    m.on("contextmenu", ()=>{
      if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ—á–∫—É '"+(p.name||"")+"'?")){
        state.points = (state.points||[]).filter(x=>x.id!==p.id);
        save();
        renderPoints();
      }
    });
  }
}
$("ptMode")?.addEventListener("click", ()=>{
  pointMode = !pointMode;
  $("ptMode").textContent = "üìç –†–µ–∂–∏–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏: " + (pointMode?"–£–≤—ñ–º–∫":"–í–∏–º–∫");
});
$("ptClear")?.addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ç–æ—á–∫–∏?")){
    state.points = [];
    save();
    renderPoints();
  }
});
document.querySelectorAll("[data-pt-example]")?.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $("ptName").value = btn.getAttribute("data-pt-example") || "";
  });
});
map.on("click", (e)=>{
  if(!pointMode) return;
  const name = ($("ptName")?.value || "").trim() || "–¢–æ—á–∫–∞";
  const iconKind = ($("ptIcon")?.value || "M");
  const img = ($("ptImg")?.value || "").trim();
  const p = { id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()), name, iconKind, img, lat:e.latlng.lat, lng:e.latlng.lng };
  state.points.push(p);
  save();
  renderPoints();
});
renderPoints();


// === Oblast toggles list (alphabet UA) ===
const OBLASTS_UA = [
  "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º",
  "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–õ—É–≥–∞–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–°—É–º—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å"
];
function normOblastName(n){
  n = (n||"").toString().trim();
  // unify common variants from geojson
  n = n.replace(/^–º\.\s*/i,"").replace(/\s+–æ–±–ª\.?$/i," –æ–±–ª–∞—Å—Ç—å");
  if(n.toLowerCase()==="–∫—Ä–∏–º" || n.toLowerCase().includes("–∫—Ä–∏–º")) return "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º";
  if(!/–æ–±–ª–∞—Å—Ç—å$/i.test(n) && !n.toLowerCase().includes("—Ä–µ—Å–ø—É–±–ª—ñ–∫–∞")) n += " –æ–±–ª–∞—Å—Ç—å";
  return n;
}
function renderOblastToggleList(){
  const box = $("oblastToggleList");
  if(!box) return;
  const sel = new Set((state.selOblasts||[]).map(normOblastName));
  box.innerHTML = OBLASTS_UA.map(name=>{
    const on = sel.size===0 ? false : sel.has(name);
    return `
      <div class="row" style="justify-content:space-between;gap:10px;">
        <div style="font-weight:700;">${escapeHtml(name)}</div>
        <div class="switch ${on?'on':''}" data-oblast="${escapeHtml(name)}"></div>
      </div>`;
  }).join("");
  box.querySelectorAll(".switch[data-oblast]").forEach(sw=>{
    sw.addEventListener("click", ()=>{
      const name = sw.getAttribute("data-oblast");
      const cur = new Set((state.selOblasts||[]).map(normOblastName));
      // if empty selection means "none selected" in UI; we will start selection set on first toggle
      if(cur.size===0){
        cur.add(name);
      } else {
        if(cur.has(name)) cur.delete(name); else cur.add(name);
      }
      state.selOblasts = [...cur];
      save();
      renderOblastToggleList();
      syncOblastSelectFromSet?.();
      applyOblastStyles?.();
    });
  });
}
$("oblastAll")?.addEventListener("click", ()=>{
  state.selOblasts = [...OBLASTS_UA];
  save(); renderOblastToggleList(); syncOblastSelectFromSet?.(); applyOblastStyles?.();
});
$("oblastNone")?.addEventListener("click", ()=>{
  state.selOblasts = [];
  save(); renderOblastToggleList(); syncOblastSelectFromSet?.(); applyOblastStyles?.();
});
// re-render when settings tab opened
document.querySelectorAll("[data-tab]")?.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    if(btn.getAttribute("data-tab")==="settings"){
      setTimeout(()=>renderOblastToggleList(), 50);
    }
  });
});

</script>

  <style>
    :root{
      --bg:#0f0f10;
      --panel:#17171a;
      --panel2:#1f1f24;
      --stroke:#ffffff;
      --muted:#b8b8c5;
      --line:#2b2b33;
      --btn:#23232a;
      --btnH:#2c2c36;
      --danger:#ff4d4d;
      --warn:#ffd54a;
      --ok:#49d17d;
      --cyan:#6fe3ff;
      --shadow: 0 10px 40px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; height:100vh; background:var(--bg); color:var(--stroke);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:grid; grid-template-columns: 380px 1fr;
    }
    #left{
      border-right:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),#121216);
      padding:12px; overflow:auto;
    }
    #mapWrap{ position:relative; height:100vh; }
    #map{ height:100%; width:100%; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:8px 10px; border:1px solid var(--line); border-radius:14px;
      background:rgba(255,255,255,0.03);
      box-shadow: var(--shadow);
      margin-bottom:10px;
    }
    .title{ font-weight:900; font-size:14px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      background:var(--btn); color:var(--stroke);
      border:1px solid #31313a;
      padding:10px 10px; border-radius:12px;
      cursor:pointer; user-select:none;
      font-weight:800; font-size:13px;
    }
    .btn:hover{ background:var(--btnH); }
    .btn.small{ padding:8px 10px; font-size:12px; font-weight:800; border-radius:11px; }
    .btn.danger{ background:#2a1616; border-color:#5b2a2a; }
    .btn.danger:hover{ background:#351a1a; }
    .btn.ok{ background:#132318; border-color:#1f4a2f; }
    .btn.ok:hover{ background:#16301f; }
    .btn.active{ outline:2px solid rgba(111,227,255,.35); }
    .tabs{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap:8px; margin-bottom:10px;
    }
    .tab{
      text-align:center; padding:10px 8px; border-radius:12px;
      border:1px solid var(--line); background:rgba(255,255,255,.02);
      font-weight:900; cursor:pointer;
    }
    .tab.active{ outline:2px solid rgba(111,227,255,.35); background:rgba(111,227,255,.08); }
    .card{
      background:rgba(255,255,255,0.03);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow: var(--shadow);
      margin-bottom:10px;
    }
    label{ font-size:12px; color:var(--muted); display:block; margin:10px 0 6px; }
    input, select{
      width:100%;
      background:var(--panel2);
      border:1px solid #343443;
      color:var(--stroke);
      padding:10px;
      border-radius:12px;
      outline:none;
      font-size:14px;
    }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }
    .hint{ color:var(--muted); font-size:12px; line-height:1.35; }
    .hr{ height:1px; background:var(--line); margin:10px 0; }
    .list{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(0,0,0,0.24);
    }
    .itemTop{ display:flex; justify-content:space-between; align-items:flex-start; gap:8px; }
    .itemTitle{ font-weight:1000; font-size:14px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:11px; padding:5px 9px; border-radius:999px;
      border:1px solid #3a3a44; color:var(--muted);
      background:rgba(255,255,255,0.03);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:50%; display:inline-block; }
    .dot.ok{ background:var(--ok); }
    .dot.warn{ background:var(--warn); }
    .dot.danger{ background:var(--danger); }
    .dot.acoustic{ background:var(--cyan); }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .pillRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,0.06);
      border:1px solid var(--line);
      font-size:12px; color:var(--muted);
      user-select:none;
    }
    .toggle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px; border-radius:14px;
      border:1px solid var(--line); background:rgba(255,255,255,0.02);
      margin-top:8px;
    }
    .toggle b{ font-size:13px; }
    .toggle small{ display:block; color:var(--muted); font-size:12px; margin-top:2px; }
    .switch{
      width:46px; height:26px; border-radius:999px;
      background:#2a2a33; border:1px solid #3a3a46;
      position:relative; cursor:pointer; flex:0 0 auto;
    }
    .switch::after{
      content:""; width:20px; height:20px; border-radius:50%;
      background:#fff; position:absolute; top:50%; left:3px;
      transform:translateY(-50%); transition: all .15s ease;
    }
    .switch.on{ background:rgba(73,209,125,.25); border-color:rgba(73,209,125,.5); }
    .switch.on::after{ left:23px; }
    /* Map overlays */
    #crosshair{
      position:absolute; inset:0; pointer-events:none; display:none;
    }
    #crosshair svg{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
    #watermark{
      position:absolute; inset:0; pointer-events:none; display:none;
      opacity:0.2;
    }
    #announce{
      position:absolute; left:12px; right:12px; bottom:12px;
      display:none;
      background:rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      font-weight:800;
    }
    #fps{
      position:absolute; right:10px; bottom:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size:12px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,0.12);
      padding:6px 10px; border-radius:12px;
      display:none; pointer-events:none;
    }
    /* Modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index:9999;
      padding:14px;
    }
    .modal{
      width:min(920px, 100%);
      background:linear-gradient(180deg,#17171a,#0f0f12);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid var(--line);
    }
    .modalTop b{ font-size:14px; }
    .modalBody{ padding:12px; }
    .closeX{ cursor:pointer; font-weight:1000; padding:6px 10px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,0.02); }
    .closeX:hover{ background:rgba(255,255,255,0.05); }
    #shotImg{ width:100%; border-radius:14px; border:1px solid var(--line); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }
  
    table.tbl{width:100%;border-collapse:collapse;}
    table.tbl th,table.tbl td{padding:10px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap;}

.dropdown{
  position:relative;
  background:#14161a;
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
  padding:6px;
  margin-top:6px;
  max-height:220px;
  overflow:auto;
}
.dropdown .item{
  padding:8px 10px;
  border-radius:10px;
  cursor:pointer;
}
.dropdown .item:hover{ background:rgba(255,255,255,.06); }
.dropdown .small{ font-size:12px; opacity:.8; display:block; }
.avatarMarker{
  width:36px;height:36px;border-radius:50%;
  display:grid;place-items:center;
  border:2px solid rgba(255,255,255,.35);
  box-shadow:0 6px 18px rgba(0,0,0,.45);
  overflow:hidden;
  background:rgba(0,0,0,.35);
}
.avatarMarker img{ width:100%; height:100%; object-fit:cover; display:block; }
.avatarLabel{
  margin-top:4px;
  padding:2px 6px;
  border-radius:10px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.14);
  font-size:12px;
  white-space:nowrap;
}

</style>
</head>

<body>
  <aside id="left">
    <div class="topbar">
      <div>
        <div class="title">Ukraine Radar Map ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ</div>
        <div class="sub">–±–µ–∑ –≤—Ö–æ–¥—É ‚Ä¢ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –±—Ä–∞—É–∑–µ—Ä—ñ ‚Ä¢ –µ–∫—Å–ø–æ—Ä—Ç/—ñ–º–ø–æ—Ä—Ç</div>
      </div>
      <div class="row">
        <button class="btn small" id="btnShot">üì∏</button>
        <button class="btn small" id="btnExport">‚¨áÔ∏è</button>
        <button class="btn small" id="btnImport">‚¨ÜÔ∏è</button>
        <input id="file" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="targets">–¶—ñ–ª—ñ</div>
      <div class="tab" data-tab="admin">–ê–¥–º—ñ–Ω</div>
      <div class="tab" data-tab="settings">‚öôÔ∏è</div>
      <div class="tab" data-tab="tools">–Ü–Ω—Å—Ç—Ä—É–º.</div><button class="btn" id="toggleMapTheme">–¢–µ–º–Ω–∞ –º–∞–ø–∞<br><label><input type='checkbox' id='toggleShaft' checked> –ü–∞–ª–∫–∞ —à–∞—Ö–µ–¥–∞</label></button></div>
    </div>

    <!-- TARGETS TAB -->
    <section class="tabPane" id="tab-targets">
      <div class="card">
        <div class="row">
          <button class="btn ok" id="btnAdd">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—ñ–ª—å</button>
          <button class="btn" id="btnCenter">üéØ –¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
          <button class="btn danger" id="btnClear">üóë –û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <label>–¢–∏–ø —Ü—ñ–ª—ñ</label>
            <select id="type">
              <option>–®–∞—Ö–µ–¥</option>
              <option>–•-59</option>
              <option>–•-101</option>
              <option>–†–æ–∑–≤—ñ–¥–Ω–∏–∫</option>
              <option>–°-300–ü–ü</option>
              <option>–ö–ê–ë</option>
              <option>–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ö</option>
              <option>–ü–£ –†–°–ó–í</option>
              <option>–ü–£ –Ü—Å–∫–∞–Ω–¥–µ—Ä</option>
              <option>–ë–∞–ª—ñ—Å—Ç–∏–∫–∞</option>
              <option>–ú—ñ–ì-31–ö</option>
              <option>FPV</option>
              <option>–ù–µ–≤—ñ–¥–æ–º–∏–π</option>
              <option>–ú–æ–ª–Ω—ñ—è</option>
              <option>–õ–∞–Ω—Ü–µ—Ç</option>
              <option>–Ü—Å–∫–∞–Ω–¥–µ—Ä-–ú</option>
              <option>–†–°–ó–í</option>
              <option>–¢–ê</option>
              <option>–ö–∏–Ω–∂–∞–ª</option>
              <option>–¢—É-22</option>
              <option>–•-22</option>
              <option>–¢—É-95–ú–°</option>
              <option>–•-31</option>
              <option>–†–æ–∑–≤./—É–¥–∞—Ä–Ω. –ë–ø–õ–ê</option>
              <option>–®–≤–∏–¥–∫—ñ—Å–Ω–∞</option>
              <option>–Ü—Ç–∞–ª–º–∞—Å</option>
              <option>–®–∞—Ö–µ–¥ 238</option>
              <option>–û—Ä–ª–∞–Ω-10</option>
              <option>–°—É–ø–µ—Ä–∫–∞–º</option>
              <option>–ó–∞–ª–∞</option>
              <option>–°—É-57</option>
              <option>–ì–µ—Ä–±–µ—Ä–∞</option>
              <option>–ü—ñ–¥–ª–æ–¥–∫–∞</option>
              <option>–ö–æ—Ä–∞–±–µ–ª—å</option>
              <option>–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è</option>
              <option>–ù–µ–≤—Å—Ç. —Ü—ñ–ª—å</option>
              <option>–¢—É-160</option>
              <option>–Ü–ª-78–ú</option>
              <option>–ö–∞–ª—ñ–±—Ä</option>
              <option>–û—Ä—ñ–æ–Ω</option>
              <option>–•-69</option>
              <option>–ó–æ–Ω–¥</option>
              <option>–ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä</option>
              <option>–Ø–†–°</option>
              <option>–®–∞—Ö–µ–¥ (–í–ü)</option>
              <option>–ì–µ—Ä–∞–Ω—å-5</option>
              <option>–†–µ—Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä</option>
              <option>–ë–ú-35</option>
              <option>–°—É-34</option>
              <option>–ê–Ω-26</option>
            </select>
          </div>
          <div>
            <label>–°—Ç–∞—Ç—É—Å</label>
            <select id="status">
              <option value="move">–†—É—Ö</option>
              <option value="threat">–ó–∞–≥—Ä–æ–∑–∞</option>
              <option value="acoustic">–ê–∫—É—Å—Ç–∏–∫–∞</option>
              <option value="acousticThreat">–ê–∫—É—Å—Ç. –∑–∞–≥—Ä–æ–∑–∞</option>
              <option value="stop">–°—Ç–æ–ø</option>
            </select>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>–ù–∞–∑–≤–∞</label>
            <input id="name" placeholder="–ù–∞–ø—Ä: Shahed-1" />
          </div>
          <div>
            <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
            <input id="count" type="number" min="1" step="1" value="1" />
          </div>
        </div>

        <div class="grid3">
          <div>
            <label>–®–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥)</label>
            <input id="speed" type="number" min="0" step="1" value="150" />
          </div>
          <div>
            <label>–î–∞–ª—å–Ω—ñ—Å—Ç—å (–∫–º)</label>
            <input id="rangeKm" type="number" min="0" step="1" value="999" />
          </div>
          <div>
            <label>–ö—É—Ä—Å (¬∞)</label>
            <input id="heading" type="number" min="0" max="359" step="1" value="90" />
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>–†–∞–¥—ñ—É—Å –∑–∞–≥—Ä–æ–∑–∏ (–∫–º)</label>
            <input id="threatRadius" type="number" min="0" step="1" value="25" />
          </div>
          <div>
            <label>–ö—É—Ç –∑–∞–≥—Ä–æ–∑–∏ (¬∞)</label>
            <input id="threatAngle" type="number" min="0" max="360" step="1" value="90" />
          </div>
        </div>

        <div class="hint" style="margin-top:10px;">
          –ù–∞—Ç–∏—Å–Ω–∏ <b>‚Äú–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—ñ–ª—å‚Äù</b>, –ø–æ—Ç—ñ–º –∫–ª–∞—Ü–Ω–∏ –ø–æ –º–∞–ø—ñ. –î–∞–ª—ñ: —Ç–∞–ø –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Üí –º–µ–Ω—é (–ø–∞—É–∑–∞/—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è/–Ω–∞–ø—Ä—è–º–æ–∫/–∫–ª–æ–Ω/–≤–∏–¥–∞–ª–∏—Ç–∏).
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div class="title">–°–ø–∏—Å–æ–∫ —Ü—ñ–ª–µ–π</div>
          <div class="row">
            <button class="btn small active" id="filterMine">–ú–æ—ó</button>
            <button class="btn small" id="filterForeign">–ß—É–∂—ñ</button>
          </div>
        </div>
        <div class="list" id="list"></div>
      </div>
    </section>

    
    <!-- ADMIN TAB -->
    <section class="tabPane" id="tab-admin" style="display:none;">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <div>
            <div class="h">–ê–¥–º—ñ–Ω</div>
            <div class="muted">–¢—É—Ç –∫–µ—Ä—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø–∞–º–∏/–∫–ª—é—á–∞–º–∏. –†–æ–∑–¥—ñ–ª –±–∞—á–∏—Ç—å —Ç—ñ–ª—å–∫–∏ –í–ª–∞—Å–Ω–∏–∫.</div>
          </div>
          <div class="pill" id="rolePill">—Ä–æ–ª—å: ‚Äî</div>
        </div>

        <div class="hr"></div>

        <div class="h2">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–ª—é—á</div>
        <div class="row">
          <input id="admNewName" class="input" placeholder="–Ü–º'—è (–Ω–∞–ø—Ä: Friend1)" />
          <select id="admNewRole" class="input" style="min-width:170px;">
            <option value="member" selected>–£—á–∞—Å–Ω–∏–∫</option>
            <option value="admin">–ê–¥–º—ñ–Ω</option>
            <option value="owner">–í–ª–∞—Å–Ω–∏–∫</option>
          </select>
          <button class="btn ok" id="admCreateKey">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <input id="admCreatedKey" class="input mono" readonly placeholder="–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –∫–ª—é—á –∑‚Äô—è–≤–∏—Ç—å—Å—è —Ç—É—Ç (–ø–æ–∫–∞–∑—É—î—Ç—å—Å—è 1 —Ä–∞–∑)" style="flex:1;min-width:260px;" />
          <button class="btn" id="admCopyKey">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
        </div>

        <div class="hr"></div>

        <div class="h2">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</div>
        <div class="row" style="margin:10px 0 8px 0;gap:8px;flex-wrap:wrap;">
          <input id="admNick" class="input" placeholder="–ù—ñ–∫ (—Ç–æ—á–Ω–æ –∞–±–æ —á–∞—Å—Ç–∏–Ω–∞)‚Ä¶" style="flex:1;min-width:240px;" />
          <button class="btn danger" id="admBanNick">–ë–∞–Ω –ø–æ –Ω—ñ–∫—É</button>
          <button class="btn" id="admUnbanNick">–†–æ–∑–±–∞–Ω –ø–æ –Ω—ñ–∫—É</button>
        </div>
        <div class="muted" style="margin-bottom:8px;">–ë–∞–Ω/—Ä–æ–∑–±–∞–Ω –ø–æ –Ω—ñ–∫—É: –≤–ª–∞—Å–Ω–∏–∫—ñ–≤ –±–∞–Ω–∏—Ç–∏ –Ω–µ –º–æ–∂–Ω–∞.</div>
    
        <div class="muted" id="admUsersMsg" style="margin-bottom:8px;"></div>
        <div style="overflow:auto;border:1px solid var(--line);border-radius:12px;">
          <table class="tbl">
            <thead>
              <tr><th>–Ü–º º—è</th><th>–†–æ–ª—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>ID</th><th>–î—ñ—è</th></tr>
            </thead>
            <tbody id="admUsersTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

<!-- SETTINGS TAB -->
    <section class="tabPane" id="tab-settings" style="display:none;">
      <div class="card">
        <div class="title">–í–∏–≥–ª—è–¥</div>

        <div class="toggle">
          <div>
            <b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∑–Ω–∞—á–∫–∏ —Å—Ç–∞—Ç—É—Å—ñ–≤</b>
            <small>–†—É—Ö / –ó–∞–≥—Ä–æ–∑–∞ / –ê–∫—É—Å—Ç–∏–∫–∞ / –ê–∫—É—Å—Ç. –∑–∞–≥—Ä–æ–∑–∞</small>
          </div>
          <div class="switch on" id="swStatusIcons"></div>
        </div>

        <div class="toggle">
          <div><b>–ù–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ –∑–∞–≥—Ä–æ–∑–∏</b><small>—Ö–æ–≤–∞—î —Å–µ–∫—Ç–æ—Ä/—Ä–∞–¥—ñ—É—Å –∑–∞–≥—Ä–æ–∑–∏</small></div>
          <div class="switch" id="swHideThreats"></div>
        </div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç–æ–≤—É –æ–±'—è–≤—É</b><small>—Ç–µ–∫—Å—Ç –≤–Ω–∏–∑—É –Ω–∞ –º–∞–ø—ñ</small></div>
          <div class="switch" id="swAnnounce"></div>
        </div>

        <label>–¢–µ–∫—Å—Ç –Ω–∞ –∫–∞—Ä—Ç—ñ</label>
        <input id="announceText" placeholder="–¢–ï–ö–°–¢ –ù–ê –ö–ê–†–¢–Ü" />

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ç–æ—á–∫–∏ –ø–æ–≤–æ—Ä–æ—Ç—É</b><small>–¥–ª—è —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó —Ü—ñ–ª—ñ</small></div>
          <div class="switch" id="swTurnPoints"></div>
        </div>

        <div class="toggle">
          <div><b>–ë—ñ–ª–∞ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ —ñ–∫–æ–Ω–æ–∫</b><small>—Å–≤—ñ—Ç—ñ–Ω–Ω—è –Ω–∞–≤–∫–æ–ª–æ –º–∞—Ä–∫–µ—Ä—ñ–≤</small></div>
          <div class="switch" id="swGlow"></div>
        </div>

        <div class="toggle">
          <div><b>–î–∏–Ω–∞–º—ñ—á–Ω–∏–π —Ä–æ–∑–º—ñ—Ä (–ó—É–º)</b><small>–º–∞—Å—à—Ç–∞–± —ñ–∫–æ–Ω–æ–∫ –≤—ñ–¥ –∑—É–º—É</small></div>
          <div class="switch on" id="swDynSize"></div>
        </div>

        <div class="hr"></div>

        <label>–ö–æ–ª—ñ—Ä —ñ–∫–æ–Ω–∫–∏</label>
        <input id="iconColor" type="color" value="#ffffff" />

        <label>–†–æ–∑–º—ñ—Ä —ñ–∫–æ–Ω–∫–∏</label>
        <input id="iconSize" type="number" min="18" step="1" value="30" />

        <label>–ö–æ–ª—ñ—Ä –ø—ñ–¥–ø–∏—Å—É</label>
        <input id="labelColor" type="color" value="#ffffff" />

        <label>–ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É –Ω–∞–∑–≤</label>
        <input id="labelBg" type="color" value="#000000" />

        <label>–†–æ–∑–º—ñ—Ä –ø—ñ–¥–ø–∏—Å—É</label>
        <input id="labelSize" type="number" min="8" step="1" value="12" />

        <div class="toggle">
          <div><b>–§–æ–Ω –¥–ª—è –Ω–∞–∑–≤</b><small>–ø—ñ–¥–∫–ª–∞–¥–∫–∞ –ø—ñ–¥ –Ω–∞–∑–≤–æ—é</small></div>
          <div class="switch on" id="swLabelBg"></div>
        </div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–∞–∑–≤–∏</b><small>—Ö–æ–≤–∞—î/–ø–æ–∫–∞–∑—É—î –ø—ñ–¥–ø–∏—Å</small></div>
          <div class="switch on" id="swLabels"></div>
        </div>
      </div>

      <div class="card">
        <div class="title">–ü—Ä–∏—Ü—ñ–ª (—Ü–µ–Ω—Ç—Ä –µ–∫—Ä–∞–Ω—É)</div>
        <div class="toggle">
          <div><b>–£–≤—ñ–º–∫–Ω—É—Ç–∏ –ø—Ä–∏—Ü—ñ–ª</b><small>–≤ —Ü–µ–Ω—Ç—Ä—ñ –º–∞–ø–∏</small></div>
          <div class="switch" id="swCrosshair"></div>
        </div>

        <label>–¢–∏–ø –ø—Ä–∏—Ü—ñ–ª—É</label>
        <select id="crosshairType">
          <option value="1">–í–∞—Ä—ñ–∞–Ω—Ç 1</option>
          <option value="2">–í–∞—Ä—ñ–∞–Ω—Ç 2</option>
          <option value="3">–í–∞—Ä—ñ–∞–Ω—Ç 3</option>
        </select>

        <div class="grid2">
          <div>
            <label>–ö–æ–ª—ñ—Ä</label>
            <input id="crosshairColor" type="color" value="#ffffff" />
          </div>
          <div>
            <label>–†–æ–∑–º—ñ—Ä (px)</label>
            <input id="crosshairSize" type="number" min="20" step="1" value="60" />
          </div>
        </div>

        <label>–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å</label>
        <input id="crosshairOpacity" type="range" min="0" max="1" step="0.05" value="0.7" />
      </div>

      <div class="card">
        <div class="title">–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è (ID)</div>
        <label>–†–µ–∂–∏–º</label>
        <select id="idMode">
          <option value="random">–í–∏–ø–∞–¥–∫–æ–≤—ñ</option>
          <option value="seq">–ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ</option>
        </select>

        <div class="grid2">
          <div>
            <label>–î—ñ–∞–ø–∞–∑–æ–Ω (–≤—ñ–¥)</label>
            <input id="idFrom" type="number" value="1000" />
          </div>
          <div>
            <label>–î—ñ–∞–ø–∞–∑–æ–Ω (–¥–æ)</label>
            <input id="idTo" type="number" value="9999" />
          </div>
        </div>

        <label>–°—É—Ñ—ñ–∫—Å</label>
        <input id="idSuffix" placeholder="–ù–∞–ø—Ä: A" />

        <div class="grid2">
          <div>
            <label>–ö–æ–ª—ñ—Ä ID</label>
            <input id="idColor" type="color" value="#ffffff" />
          </div>
          <div>
            <label>–†–æ–∑–º—ñ—Ä ID</label>
            <input id="idSize" type="number" value="12" />
          </div>
        </div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ ID</b><small>–Ω–∞–¥ —Ü—ñ–ª–ª—é</small></div>
          <div class="switch" id="swShowId"></div>
        </div>
      </div>

      <div class="card">
        <div class="title">–ö–∞—Ä—Ç–∞ —Ç–∞ –ú–µ–∂—ñ</div>

        <label>–ü—ñ–¥–∫–ª–∞–¥–∫–∞ (—Ç–∞–π–ª–∏)</label>
        <div class="row" style="gap:10px;align-items:end;margin-bottom:10px;flex-wrap:wrap;">
  <div style="flex:1;min-width:220px;">
    <label>–ü–æ—à—É–∫ –º—ñ—Å—Ç–∞</label>
    <input id="citySearch" class="input" placeholder="–í–≤–µ–¥–∏ –º—ñ—Å—Ç–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤, –õ—å–≤—ñ–≤)..." />
    <div id="cityResults" class="dropdown" style="display:none;"></div>
  </div>
  <div style="min-width:180px;">
    <label>–ü—ñ–¥–∫–ª–∞–¥–∫–∞ (—Ç–∞–π–ª–∏)</label>
    <select id="baseLayer">

          <option value="osm">OSM</option>
          <option value="dark">OSM Dark</option>
          <option value="sat">Satellite (ESRI)</option>
        </select>

        <div class="toggle">
          <div><b>–ö–æ—Ä–¥–æ–Ω –£–∫—Ä–∞—ó–Ω–∏</b><small>GeoJSON (–∫—Ä–∞—ó–Ω–∞)</small></div>
          <div class="switch on" id="swBorder"></div>
        </div>
        <div class="row" style="gap:10px;align-items:center;margin:-2px 0 12px 0;">
          <div class="muted" style="min-width:160px;">–ö–æ–Ω—Ç—É—Ä –∫—Ä–∞—ó–Ω–∏</div>
          <input type="color" id="borderStroke" class="input" style="width:64px;min-width:64px;padding:6px;" />
        </div>

        <div class="toggle">
          <div><b>–ú–µ–∂—ñ –æ–±–ª–∞—Å—Ç–µ–π</b><small>regiony.geojson</small></div>
          <div class="switch" id="swOblast"></div>
        </div>
        <div class="row" style="gap:10px;align-items:center;margin:-2px 0 12px 0;">
          <div class="muted" style="min-width:160px;">–ö–æ–Ω—Ç—É—Ä –æ–±–ª–∞—Å—Ç–µ–π</div>
          <input type="color" id="oblastStroke" class="input" style="width:64px;min-width:64px;padding:6px;" />
        </div>

        <div class="toggle">
          <div><b>–ú–µ–∂—ñ —Ä–∞–π–æ–Ω—ñ–≤</b><small>rayony.geojson (–≤–∞–∂–∫–∏–π —à–∞—Ä)</small></div>
          <div class="switch" id="swRaion"></div>
        </div>
        <div class="row" style="gap:10px;align-items:center;margin:-2px 0 12px 0;">
          <div class="muted" style="min-width:160px;">–ö–æ–Ω—Ç—É—Ä —Ä–∞–π–æ–Ω—ñ–≤</div>
          <input type="color" id="raionStroke" class="input" style="width:64px;min-width:64px;padding:6px;" />
        </div>

        <div class="toggle">
          <div><b>–¢—ñ–ª—å–∫–∏ –£–∫—Ä–∞—ó–Ω–∞ (—ñ–Ω—à–µ —á–æ—Ä–Ω–µ)</b><small>–º–∞—Å–∫–∞ –∑–∞ –º–µ–∂–∞–º–∏ –∫–æ—Ä–¥–æ–Ω—É</small></div>
          <div class="switch" id="swMask"></div>
        </div>

        <div class="hr"></div>

        <label>–í–∏–¥—ñ–ª–∏—Ç–∏ –æ–±–ª–∞—Å—Ç—ñ (–º—É–ª—å—Ç–∏–≤–∏–±—ñ—Ä)</label>
      <div class="card" style="margin-top:12px;">
        <div class="title">–í–∏–±—ñ—Ä –æ–±–ª–∞—Å—Ç–µ–π (—Å–≤—ñ—Ç—á—ñ)</div>
        <div class="row" style="gap:10px;flex-wrap:wrap;margin:8px 0;">
          <button class="btn small" id="oblastAll">–í–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ</button>
          <button class="btn small" id="oblastNone">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
        <div id="oblastToggleList" style="display:grid;grid-template-columns:1fr;gap:8px;max-height:260px;overflow:auto;padding-right:4px;"></div>
        <div class="muted" style="margin-top:8px;">–ú–æ–∂–Ω–∞ –≤–º–∏–∫–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –æ–±–ª–∞—Å—Ç–µ–π. –ù–µ–≤–∏–±—Ä–∞–Ω—ñ –∑–∞—Ç–µ–º–Ω—é—é—Ç—å—Å—è –Ω–∞ 70%.</div>
      </div>

        <select id="oblastSelect" multiple size="8"></select>
        <div class="row" style="margin-top:8px;">
          <button class="btn small" id="btnOblastReset">–°–∫–∏–Ω—É—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è</button>
        </div>
      </div>

      <div class="card">
        <div class="title">–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è —Ç–∞ –ü—Ä–æ–≥–Ω–æ–∑</div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó</b><small>–ª—ñ–Ω—ñ—è —Ä—É—Ö—É</small></div>
          <div class="switch on" id="swTraj"></div>
        </div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ª—ñ–Ω—ñ—ó –Ω–∞–ø—Ä—è–º–∫—É</b><small>—Å—Ç—Ä—ñ–ª–∫–∞ –≤–ø–µ—Ä–µ–¥</small></div>
          <div class="switch on" id="swDirLine"></div>
        </div>

        <label>–°—Ç–∏–ª—å —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó</label>
        <select id="trajStyle">
          <option value="solid">–°—É—Ü—ñ–ª—å–Ω–∞</option>
          <option value="dash">–ü—É–Ω–∫—Ç–∏—Ä–Ω–∞</option>
        </select>

        <div class="grid3">
          <div>
            <label>–ö–æ–ª—ñ—Ä</label>
            <input id="trajColor" type="color" value="#49d17d" />
          </div>
          <div>
            <label>–®–∏—Ä–∏–Ω–∞</label>
            <input id="trajWidth" type="number" value="3" min="1" />
          </div>
          <div>
            <label>–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å</label>
            <input id="trajOpacity" type="range" min="0" max="1" step="0.05" value="0.9" />
          </div>
        </div>

        <div class="hr"></div>

        <label>–ü—Ä–æ–≥–Ω–æ–∑ (—Ö–≤–∏–ª–∏–Ω)</label>
        <input id="forecastMin" type="number" min="1" value="20" />
        <div class="row" style="margin-top:8px;">
          <button class="btn small" id="btnForecastShow">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑</button>
          <button class="btn small" id="btnForecastClear">–ü—Ä–∏–±—Ä–∞—Ç–∏</button>
        </div>
      </div>

      <div class="card">
        <div class="title">–°–∏—Å—Ç–µ–º–∞</div>

        <label>–ß–∞—Å—Ç–æ—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</label>
        <select id="tickRate">
          <option value="1">1 —Å–µ–∫</option>
          <option value="2">2 —Å–µ–∫</option>
          <option value="3">3 —Å–µ–∫</option>
          <option value="5" selected>5 —Å–µ–∫</option>
          <option value="10">10 —Å–µ–∫</option>
          <option value="smooth">–ü–ª–∞–≤–Ω–∏–π</option>
        </select>

        <label>–†–µ–∂–∏–º –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
        <select id="renderMode">
          <option value="100">–ó–≤–∏—á–∞–π–Ω–∏–π (100%)</option>
          <option value="50">–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∏–π (50%)</option>
        </select>

        <div class="toggle">
          <div><b>FPS –ª—ñ—á–∏–ª—å–Ω–∏–∫</b><small>–≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞</small></div>
          <div class="switch" id="swFps"></div>
        </div>
      </div>
    </section>

    <!-- TOOLS TAB -->
    <section class="tabPane" id="tab-tools" style="display:none;">
      <div class="card">
        <div class="title">–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</div>

        <div class="row">
          <button class="btn small" id="btnSpeed">‚è±Ô∏è –®–≤–∏–¥–∫—ñ—Å—Ç—å</button>
          <button class="btn small" id="btnWatermark">–í–æ–¥. –∑–Ω–∞–∫</button>
          <button class="btn small" id="btnStatic">–û–±'—î–∫—Ç–∏</button>
        </div>

        <div class="hr"></div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –º–æ—ó —Ü—ñ–ª—ñ</b><small>—Ñ—ñ–ª—å—Ç—Ä ‚Äú–ú–æ—ó‚Äù</small></div>
          <div class="switch on" id="swOnlyMine"></div>
        </div>

        <div class="hr"></div>

        <div class="hint">
          ‚ö†Ô∏è ‚Äú–°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ / –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–ª—é—á—ñ / –í–∏–π—Ç–∏‚Äù ‚Äî —Ü–µ —á–∞—Å—Ç–∏–Ω–∞ –≤—Ö–æ–¥—É –Ω–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–º—É —Å–∞–π—Ç—ñ.
          –¢—É—Ç –≤—Ö–æ–¥—É –Ω–µ–º–∞—î, —Ç–æ–º—É —Ü–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤ —Ç–µ–∂ –Ω–µ–º–∞—î.
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn" id="btnReload">–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
          <button class="btn danger" id="btnClear2">Ô∏è–û—á–∏—Å—Ç–∏—Ç–∏ —Ü—ñ–ª—ñ</button>
        </div>
      </div>

      <div class="card">
        <div class="title">–ü–æ–≤—ñ—Ç—Ä—è–Ω—ñ —Ç—Ä–∏–≤–æ–≥–∏ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</div>
        <div class="hint">
          –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∞ –º–∞–ø–∞ –ø–æ–∫–∞–∑—É—î —Ç—Ä–∏–≤–æ–≥–∏ –∑ —Å–µ—Ä–≤—ñ—Å—ñ–≤. –î–ª—è –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–≥–æ UkraineAlarm –ø–æ—Ç—Ä—ñ–±–µ–Ω API-–∫–ª—é—á, –∞ –¥–ª—è —ñ–Ω—à–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è CORS.
          –¢—É—Ç –∑—Ä–æ–±–ª–µ–Ω–æ <b>–ø–æ–ª–µ –¥–ª—è –∫–ª—é—á–∞</b> —ñ ‚Äú–∑–∞–≥–æ—Ç–æ–≤–∫—É‚Äù –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.
        </div>

        <label>–°–µ—Ä–≤—ñ—Å</label>
        <select id="alarmService">
          <option value="none">–í–∏–º–∫–Ω–µ–Ω–æ</option>
          <option value="ukrainealarm">UkraineAlarm (–ø–æ—Ç—Ä—ñ–±–µ–Ω –∫–ª—é—á)</option>
          <option value="custom">–°–≤—ñ–π GeoJSON (—ñ–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–æ–º)</option>
        </select>

        <label>UkraineAlarm API key</label>
        <input id="uaKey" placeholder="–í—Å—Ç–∞–≤ –∫–ª—é—á (—è–∫—â–æ –º–∞—î—à)" />

        <div class="toggle">
          <div><b>–í—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ —Ç—Ä–∏–≤–æ–≥–∏ –æ–Ω–ª–∞–π–Ω</b><small>—è–∫—â–æ –∫–ª—é—á/–¥–∞–Ω—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ</small></div>
          <div class="switch" id="swAlarms"></div>
        </div>

        <label>–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å</label>
        <input id="alarmOpacity" type="range" min="0" max="1" step="0.05" value="0.10" />

        <div class="row" style="margin-top:8px;">
          <button class="btn small" id="btnAlarmImport">–Ü–º–ø–æ—Ä—Ç GeoJSON</button>
          <input id="alarmFile" type="file" accept="application/json" style="display:none" />
          <button class="btn small" id="btnAlarmClear">–ü—Ä–∏–±—Ä–∞—Ç–∏</button>
        </div>
      </div>

      <div class="card">
        <div class="title">–õ—ñ–Ω—ñ—è —Ñ—Ä–æ–Ω—Ç—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</div>
        <div class="hint">
          –ù–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ–π –º–∞–ø—ñ —î —Ñ—Ä–æ–Ω—Ç. –¢—É—Ç ‚Äî —ñ–º–ø–æ—Ä—Ç GeoJSON (–ª—ñ–Ω—ñ—è/–ø–æ–ª—ñ–≥–æ–Ω), —â–æ–± —Ç–∏ –º—ñ–≥ –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±—É–¥—å-—è–∫–µ –¥–∂–µ—Ä–µ–ª–æ.
        </div>

        <div class="toggle">
          <div><b>–ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ—Ä–æ–Ω—Ç</b><small>–≤–º–∏–∫–∞—î —à–∞—Ä —Ñ—Ä–æ–Ω—Ç—É</small></div>
          <div class="switch" id="swFront"></div>
        </div>

        <div class="grid2">
          <div>
            <label>–õ—ñ–Ω—ñ—è</label>
            <input id="frontLineColor" type="color" value="#ff4d4d" />
          </div>
          <div>
            <label>–ó–∞–ª–∏–≤–∫–∞</label>
            <input id="frontFillColor" type="color" value="#ff4d4d" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <button class="btn small" id="btnFrontImport">–Ü–º–ø–æ—Ä—Ç GeoJSON</button>
          <input id="frontFile" type="file" accept="application/json" style="display:none" />
          <button class="btn small" id="btnFrontClear">–ü—Ä–∏–±—Ä–∞—Ç–∏</button>
        </div>
      </div>
    </section>
  </aside>

  <main id="mapWrap">
    <div id="map"></div>
    <canvas id="watermark"></canvas>
    <div id="crosshair"></div>
    <div id="announce"></div>
    <div id="fps" class="mono">FPS: --</div>
  </main>

  <!-- Screenshot modal -->
  <div class="modalBack" id="shotModal">
    <div class="modal">
      <div class="modalTop">
        <b>–ó–Ω—ñ–º–æ–∫ –µ–∫—Ä–∞–Ω–∞</b>
        <div class="row">
          <button class="btn small" id="btnSaveShot">‚¨áÔ∏è –ó–±–µ—Ä–µ–≥—Ç–∏ —É —Ñ–∞–π–ª</button>
          <div class="closeX" id="btnCloseShot">√ó</div>
        </div>
      </div>
      <div class="modalBody">
        <div class="hint">–ó–∞—Ç–∏—Å–Ω—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ (–Ω–∞ iOS).</div>
        <div style="height:10px"></div>
        <img id="shotImg" alt="screenshot" />
      </div>
    </div>
  </div>

<script>
/* =========================
   Local clone: core features
   ========================= */

const LS_KEY = "ua_radar_local_v2";

const $ = (id) => document.getElementById(id);
const state = {
  addMode:false,
  filter:"mine", // mine|foreign
  onlyMine:true,
  seqNext: 1000,

  // settings
  showStatusIcons:true,
  hideThreats:false,
  showAnnounce:false,
  announceText:"",
  showTurnPoints:false,
  glow:false,
  dynSize:true,

  iconColor:"#ffffff",
  iconSize:30,
  labelColor:"#ffffff",
  labelBg:"#000000",
  labelSize:12,
  labelBgOn:true,
  labelsOn:true,

  crosshairOn:false,
  crosshairType:"1",
  crosshairColor:"#ffffff",
  crosshairSize:60,
  crosshairOpacity:0.7,

  showId:false,
  idMode:"random",
  idFrom:1000,
  idTo:9999,
  idSuffix:"",
  idColor:"#ffffff",
  idSize:12,

  baseLayer:"osm",
  borderOn:true,
  borderStroke:"#ffffff",
  oblastStroke:"#ffffff",
  raionStroke:"#ffffff",
  oblastOn:false,
  raionOn:false,
  maskOn:false,
  highlightedOblasts:[],

  trajOn:true,
  dirLineOn:true,
  trajStyle:"solid",
  trajColor:"#49d17d",
  trajWidth:3,
  trajOpacity:0.9,
  forecastMin:20,

  tickRate:"5",
  renderMode:"100",
  fpsOn:false,

  // optional overlays
  alarmsOn:false,
  alarmService:"none",
  uaKey:"",
  alarmOpacity:0.10,

  frontOn:false,
  frontLineColor:"#ff4d4d",
  frontFillColor:"#ff4d4d",
};

let data = {
  targets: [],  // {id, owner: mine|foreign, type, status, name, count, speed, rangeKm, heading, threatRadius, threatAngle, lat,lng, createdAt, paused, points:[{lat,lng}], trajectory:[{lat,lng,t}]}
  alarmsGeojson: null,
  frontGeojson: null,
};

const layersById = new Map(); // id -> {marker,label,dirLine,traj,turnPoints,threatSector,idLabel}
let forecastLayer = null;

// --- Helpers ---
function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function kmToMeters(km){ return km*1000; }
function deg2rad(d){ return d*Math.PI/180; }
function rad2deg(r){ return r*180/Math.PI; }

function destinationPoint(lat, lng, bearingDeg, distM) {
  const R = 6371000;
  const brng = deg2rad(bearingDeg);
  const œÜ1 = deg2rad(lat);
  const Œª1 = deg2rad(lng);
  const Œ¥ = distM / R;

  const œÜ2 = Math.asin(Math.sin(œÜ1)*Math.cos(Œ¥) + Math.cos(œÜ1)*Math.sin(Œ¥)*Math.cos(brng));
  const Œª2 = Œª1 + Math.atan2(Math.sin(brng)*Math.sin(Œ¥)*Math.cos(œÜ1), Math.cos(Œ¥) - Math.sin(œÜ1)*Math.sin(œÜ2));
  return { lat: rad2deg(œÜ2), lng: rad2deg(Œª2) };
}

function statusDot(status){
  if(status==="threat") return "danger";
  if(status==="acoustic") return "acoustic";
  if(status==="acousticThreat") return "danger";
  if(status==="stop") return "warn";
  return "ok";
}
function statusText(status){
  return ({
    move:"–†—É—Ö",
    threat:"–ó–∞–≥—Ä–æ–∑–∞",
    acoustic:"–ê–∫—É—Å—Ç–∏–∫–∞",
    acousticThreat:"–ê–∫—É—Å—Ç. –∑–∞–≥—Ä–æ–∑–∞",
    stop:"–°—Ç–æ–ø"
  })[status] || status;
}

// --- Map ---
const map = L.map("map", { zoomControl:true }).setView([48.3794, 31.1656], 6);
// === Base map layers (light/dark) ===
const lightLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19, attribution:"¬© OpenStreetMap"});
const darkLayer  = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {maxZoom:19, attribution:"¬© CARTO"});
if(typeof lightLayer!=="undefined") lightLayer.addTo(map);


const baseLayers = {
  osm: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19, attribution:"&copy; OpenStreetMap" }),
  dark: L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { maxZoom:19, attribution:"&copy; OpenStreetMap, CARTO" }),
  sat: L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { maxZoom:19, attribution:"Tiles &copy; Esri" }),
};
baseLayers.osm.addTo(map);

// Borders/regions/raions from open geojson repos
// regiony/rayony/hromady dataset: https://github.com/slawomirmatuszak/ukrainian_geodata ÓàÄciteÓàÇturn8view0ÓàÅ
const GEO_BASE = "https://raw.githubusercontent.com/slawomirmatuszak/ukrainian_geodata/main/";
const borderUrl = "https://raw.githubusercontent.com/EugeneBorshch/ukraine_geojson/master/UA_FULL_Ukraine.geojson"; // UA outline ÓàÄciteÓàÇturn4view0ÓàÅ

let borderLayer = null;
let oblastLayer = null;
let raionLayer = null;
let maskLayer = null;

async function fetchJson(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error("fetch failed " + r.status);
  return await r.json();
}

function styleBorder(){ return { color: state.borderStroke || "#ffffff", weight:2, opacity:0.9, fillOpacity:0 }; }
function styleRegion(f){ 
  const name = (f.properties?.name || f.properties?.NAME_1 || f.properties?.region || "").toString();
  const isHi = state.highlightedOblasts.includes(name);
  return {
    color: isHi ? "#6fe3ff" : (state.oblastStroke || "#ffffff"),
    weight: isHi ? 3 : 1.2,
    opacity: 0.85,
    fillOpacity: isHi ? 0.08 : 0.0,
    fillColor: "#6fe3ff",
  };
}
function styleRaion(){ return { color: state.raionStroke || "#ffffff", weight:0.8, opacity:0.35, fillOpacity:0 }; }

async function ensureBorder(){
  if(borderLayer) return;
  const gj = await fetchJson(borderUrl);
  borderLayer = L.geoJSON(gj, { style: styleBorder }).addTo(map);
  rebuildMask(); // if mask enabled later
}

async function ensureOblast(){
  if(oblastLayer) return;
  const gj = await fetchJson(GEO_BASE + "regiony.geojson");
  oblastLayer = L.geoJSON(gj, { style: styleRegion });
  populateOblastSelect(gj);
}
async function ensureRaion(){
  if(raionLayer) return;
  const gj = await fetchJson(GEO_BASE + "rayony.geojson");
  raionLayer = L.geoJSON(gj, { style: styleRaion });
}

function rebuildMask(){
  if(maskLayer){ map.removeLayer(maskLayer); maskLayer=null; }
  if(!state.maskOn || !borderLayer) return;

  // Simple mask: world rectangle with hole (Ukraine polygon) using leaflet geoJSON
  const world = [[-90,-180],[-90,180],[90,180],[90,-180],[-90,-180]];
  const uk = borderLayer.toGeoJSON();
  // Get first polygon coords
  const ukCoords = (uk.features?.[0]?.geometry?.coordinates) || [];
  // GeoJSON Polygon with hole: [outer, hole]
  const mask = {
    "type":"Feature",
    "properties":{},
    "geometry":{
      "type":"Polygon",
      "coordinates":[ world, ...ukCoords ] // works for MultiPolygon too-ish; good enough for this local clone
    }
  };
  maskLayer = L.geoJSON(mask, {
    style:{ color:"#000000", weight:0, fillColor:"#000000", fillOpacity:0.65 }
  }).addTo(map);
}

// --- Markers (icon+label) ---
function makeIconForTarget(t, sizePx){
  const glow = state.glow ? `filter: drop-shadow(0 0 10px rgba(255,255,255,0.35));` : "";
  const type = (t.type||"").toString().trim().toLowerCase();
  const isShahed = type.includes("—à–∞—Ö–µ–¥") || type.includes("shahed");
  const heading = Number(t.heading ?? 0);
  if(isShahed){
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 170 153">
<path fill="currentColor" d="M89.6667 10.3333C89.2222 10.7778 90.2778 10.7222 90.3333 10.6667C90.7778 10.2222 89.7222 10.2778 89.6667 10.3333z"/>
<path fill="currentColor" d="M91 10L92 11L91 10z"/>
<path fill="currentColor" d="M87 11L88 12L87 11z"/>
<path fill="currentColor" d="M88 11L89 12L88 11z"/>
<path fill="currentColor" d="M36 136C41.0298 135.603 45.9554 134.261 51 134.039C61.6831 133.571 72.3041 135 83 135L83 131C84.6352 131.545 84.4549 131.365 85 133C89.4225 130.54 94.0688 131 99 131L99 135C115.113 136.272 132.237 134.117 148 138C148 128.233 149.032 117.132 144.86 108C141.546 100.744 134.926 94.2115 130.003 88C123.021 79.1904 116.731 69.8517 109.79 61C105.569 55.6172 99.1293 49.461 96.7384 43C94.1223 35.9304 96 25.4843 96 18C92.71 18 92.8122 13.8059 92 11C78.0933 13.9598 86.6319 36.4252 83.0054 46C80.4727 52.6869 74.9526 59.0596 71 65C65.2794 73.5976 59.9211 82.4323 54.1636 91C50.51 96.4369 45.8465 102.026 43.1389 108C42.1424 110.199 42.2788 112.618 41.4159 114.83C40.3851 117.473 38.0877 119.369 37.0085 122.015C35.2783 126.256 36 131.512 36 136z"/>
<path fill="currentColor" d="M92.3333 11.6667C92.2778 11.7222 92.2222 12.7778 92.6667 12.3333C92.7222 12.2778 92.7778 11.2222 92.3333 11.6667z"/>
<path fill="currentColor" d="M86 12L87 13L86 12z"/>
<path fill="currentColor" d="M93 12L93 15L95 14C94.4549 12.3648 94.6352 12.5451 93 12z"/>
<path fill="currentColor" d="M86 13L87 14L86 13z"/>
<path fill="currentColor" d="M85 14L86 15L85 14z"/>
<path fill="currentColor" d="M93 16L96 16L95 14C93.3648 14.5451 93.5451 14.3648 93 16z"/>
<path fill="currentColor" d="M95 14L96 15L95 14z"/>
<path fill="currentColor" d="M85 15L86 16L85 15z"/>
<path fill="currentColor" d="M84 16L85 17L84 16z"/>
<path fill="currentColor" d="M93 16C93.6913 17.3884 93.9846 17.8606 95 19C95.9857 17.5215 96 17.7968 96 16L93 16z"/>
<path fill="currentColor" d="M84 17L85 18L84 17z"/>
<path fill="currentColor" d="M96 17L97 18L96 17z"/>
<path fill="currentColor" d="M84 18L85 19L84 18z"/>
<path fill="currentColor" d="M96.3333 18.6667C96.2778 18.7222 96.2222 19.7778 96.6667 19.3333C96.7223 19.2777 96.7777 18.2223 96.3333 18.6667z"/>
<path fill="currentColor" d="M96 20L96 23C96.6961 21.4463 96.6961 21.5537 96 20z"/>
<path fill="currentColor" d="M83 21L83 24C83.6961 22.4463 83.6961 22.5537 83 21z"/>
<path fill="currentColor" d="M97.3333 21.6667C97.2778 21.7222 97.2222 22.7778 97.6667 22.3333C97.7223 22.2777 97.7777 21.2223 97.3333 21.6667z"/>
<path fill="currentColor" d="M96 23L96 44C98.153 38.8692 98.153 28.1308 96 23z"/>
<path fill="currentColor" d="M97 23L97 45C99.2187 39.7127 99.2187 28.2873 97 23z"/>
<path fill="currentColor" d="M83 24L83 36C84.5124 32.3957 84.5124 27.6043 83 24z"/>
<path fill="currentColor" d="M83 36L83 45C84.2561 42.0059 84.2561 38.9941 83 36z"/>
<path fill="currentColor" d="M75 44L75 57C76.5909 53.2087 76.5909 47.7913 75 44z"/>
<path fill="currentColor" d="M76 44L76 56C77.9247 52.6712 77.4834 47.5337 76 44z"/>
<path fill="currentColor" d="M83 45L84 46L83 45z"/>
<path fill="currentColor" d="M97 45L98 46L97 45z"/>
<path fill="currentColor" d="M98 45L99 46L98 45z"/>
<path fill="currentColor" d="M82 46L83 47L82 46z"/>
<path fill="currentColor" d="M98 46L99 47L98 46z"/>
<path fill="currentColor" d="M82 47L83 48L82 47z"/>
<path fill="currentColor" d="M99 47L100 48L99 47z"/>
<path fill="currentColor" d="M81 48L82 49L81 48z"/>
<path fill="currentColor" d="M100 48L101 49L100 48z"/>
<path fill="currentColor" d="M80 49L81 50L80 49z"/>
<path fill="currentColor" d="M81 49L82 50L81 49z"/>
<path fill="currentColor" d="M106 49L107 50L106 49z"/>
<path fill="currentColor" d="M109 49L109 56C110.059 53.4657 110.059 51.5343 109 49z"/>
<path fill="currentColor" d="M110 49L110 61C111.512 57.3957 111.512 52.6043 110 49z"/>
<path fill="currentColor" d="M80 50L81 51L80 50z"/>
<path fill="currentColor" d="M101 50L102 51L101 50z"/>
<path fill="currentColor" d="M105 50C104.806 51.8566 104.79 53.1533 105 55C105.83 52.9695 105.83 52.0305 105 50z"/>
<path fill="currentColor" d="M106 50L106 57C107.059 54.4657 107.059 52.5343 106 50z"/>
<path fill="currentColor" d="M79 51L80 52L79 51z"/>
<path fill="currentColor" d="M102 51L103 52L102 51z"/>
<path fill="currentColor" d="M79 52L80 53L79 52z"/>
<path fill="currentColor" d="M103 52L104 53L103 52z"/>
<path fill="currentColor" d="M78 53L79 54L78 53z"/>
<path fill="currentColor" d="M104 54L105 55L104 54z"/>
<path fill="currentColor" d="M77 55L78 56L77 55z"/>
<path fill="currentColor" d="M105 55L106 56L105 55z"/>
<path fill="currentColor" d="M109 56C108.782 57.6865 108.776 58.3161 109 60C109.71 58.2405 109.71 57.7595 109 56z"/>
<path fill="currentColor" d="M75 57L76 58L75 57z"/>
<path fill="currentColor" d="M107 57L108 58L107 57z"/>
<path fill="currentColor" d="M75 58L76 59L75 58z"/>
<path fill="currentColor" d="M107 58L108 59L107 58z"/>
<path fill="currentColor" d="M74 59L75 60L74 59z"/>
<path fill="currentColor" d="M108 59L109 60L108 59z"/>
<path fill="currentColor" d="M73 60L74 61L73 60z"/>
<path fill="currentColor" d="M109 60L110 61L109 60z"/>
<path fill="currentColor" d="M73 61L74 62L73 61z"/>
<path fill="currentColor" d="M110 61L111 62L110 61z"/>
<path fill="currentColor" d="M72 62L73 63L72 62z"/>
<path fill="currentColor" d="M111 62L112 63L111 62z"/>
<path fill="currentColor" d="M71 63L72 64L71 63z"/>
<path fill="currentColor" d="M111 63L112 64L111 63z"/>
<path fill="currentColor" d="M71 64L72 65L71 64z"/>
<path fill="currentColor" d="M112 64L113 65L112 64z"/>
<path fill="currentColor" d="M70 65L71 66L70 65z"/>
<path fill="currentColor" d="M113 65L114 66L113 65z"/>
<path fill="currentColor" d="M69 66L70 67L69 66z"/>
<path fill="currentColor" d="M114 66L115 67L114 66z"/>
<path fill="currentColor" d="M68 67L69 68L68 67z"/>
<path fill="currentColor" d="M69 67L70 68L69 67z"/>
<path fill="currentColor" d="M114 67L115 68L114 67z"/>
<path fill="currentColor" d="M68 68L69 69L68 68z"/>
<path fill="currentColor" d="M115 68L116 69L115 68z"/>
<path fill="currentColor" d="M67 69L68 70L67 69z"/>
<path fill="currentColor" d="M116 69L117 70L116 69z"/>
<path fill="currentColor" d="M67 70L68 71L67 70z"/>
<path fill="currentColor" d="M117 70L118 71L117 70z"/>
<path fill="currentColor" d="M66 71L67 72L66 71z"/>
<path fill="currentColor" d="M65 72L66 73L65 72z"/>
<path fill="currentColor" d="M118 72L119 73L118 72z"/>
<path fill="currentColor" d="M65 73L66 74L65 73z"/>
<path fill="currentColor" d="M119 73L120 74L119 73z"/>
<path fill="currentColor" d="M64 74L65 75L64 74z"/>
<path fill="currentColor" d="M120 74L121 75L120 74z"/>
<path fill="currentColor" d="M63 75L64 76L63 75z"/>
<path fill="currentColor" d="M120 75L121 76L120 75z"/>
<path fill="currentColor" d="M63 76L64 77L63 76z"/>
<path fill="currentColor" d="M121 76L122 77L121 76z"/>
<path fill="currentColor" d="M62 77L63 78L62 77z"/>
<path fill="currentColor" d="M122 77L123 78L122 77z"/>
<path fill="currentColor" d="M62 78L63 79L62 78z"/>
<path fill="currentColor" d="M61 79L62 80L61 79z"/>
<path fill="currentColor" d="M123 79L124 80L123 79z"/>
<path fill="currentColor" d="M60 80L61 81L60 80z"/>
<path fill="currentColor" d="M124 80L125 81L124 80z"/>
<path fill="currentColor" d="M125 81L126 82L125 81z"/>
<path fill="currentColor" d="M59 82L60 83L59 82z"/>
<path fill="currentColor" d="M125 82L126 83L125 82z"/>
<path fill="currentColor" d="M58 83L59 84L58 83z"/>
<path fill="currentColor" d="M126 83L127 84L126 83z"/>
<path fill="currentColor" d="M58 84L59 85L58 84z"/>
<path fill="currentColor" d="M127 84L128 85L127 84z"/>
<path fill="currentColor" d="M57 85L58 86L57 85z"/>
<path fill="currentColor" d="M128 85L129 86L128 85z"/>
<path fill="currentColor" d="M57 86L58 87L57 86z"/>
<path fill="currentColor" d="M128 86L129 87L128 86z"/>
<path fill="currentColor" d="M56 87L57 88L56 87z"/>
<path fill="currentColor" d="M129 87L130 88L129 87z"/>
<path fill="currentColor" d="M55 88L56 89L55 88z"/>
<path fill="currentColor" d="M130 88L131 89L130 88z"/>
<path fill="currentColor" d="M131 89L132 90L131 89z"/>
<path fill="currentColor" d="M54 90L55 91L54 90z"/>
<path fill="currentColor" d="M132 90L133 91L132 90z"/>
<path fill="currentColor" d="M53 91L54 92L53 91z"/>
<path fill="currentColor" d="M132 91L133 92L132 91z"/>
<path fill="currentColor" d="M52 92L53 93L52 92z"/>
<path fill="currentColor" d="M53 92L54 93L53 92z"/>
<path fill="currentColor" d="M133 92L134 93L133 92z"/>
<path fill="currentColor" d="M52 93L53 94L52 93z"/>
<path fill="currentColor" d="M134 93L135 94L134 93z"/>
<path fill="currentColor" d="M51 94L52 95L51 94z"/>
<path fill="currentColor" d="M135 94L136 95L135 94z"/>
<path fill="currentColor" d="M50 95L51 96L50 95z"/>
<path fill="currentColor" d="M136 95L137 96L136 95z"/>
<path fill="currentColor" d="M50 96L51 97L50 96z"/>
<path fill="currentColor" d="M136 96L137 97L136 96z"/>
<path fill="currentColor" d="M49 97L50 98L49 97z"/>
<path fill="currentColor" d="M137 97L138 98L137 97z"/>
<path fill="currentColor" d="M48 98L49 99L48 98z"/>
<path fill="currentColor" d="M138 98L139 99L138 98z"/>
<path fill="currentColor" d="M48 99L49 100L48 99z"/>
<path fill="currentColor" d="M47 100L48 101L47 100z"/>
<path fill="currentColor" d="M139 100L140 101L139 100z"/>
<path fill="currentColor" d="M46 101L47 102L46 101z"/>
<path fill="currentColor" d="M47 101L48 102L47 101z"/>
<path fill="currentColor" d="M140 101L141 102L140 101z"/>
<path fill="currentColor" d="M46 102L47 103L46 102z"/>
<path fill="currentColor" d="M141 102L142 103L141 102z"/>
<path fill="currentColor" d="M45 103L46 104L45 103z"/>
<path fill="currentColor" d="M142 103L143 104L142 103z"/>
<path fill="currentColor" d="M45 104L46 105L45 104z"/>
<path fill="currentColor" d="M142 104L143 105L142 104z"/>
<path fill="currentColor" d="M44 105L45 106L44 105z"/>
<path fill="currentColor" d="M143 105L144 106L143 105z"/>
<path fill="currentColor" d="M43 106L44 107L43 106z"/>
<path fill="currentColor" d="M144 106L145 107L144 106z"/>
<path fill="currentColor" d="M42 107L43 108L42 107z"/>
<path fill="currentColor" d="M145 107L146 108L145 107z"/>
<path fill="currentColor" d="M42 108L43 109L42 108z"/>
<path fill="currentColor" d="M145 108L146 109L145 108z"/>
<path fill="currentColor" d="M146 108L147 109L146 108z"/>
<path fill="currentColor" d="M41 109L42 110L41 109z"/>
<path fill="currentColor" d="M146 109L146 117C147.161 114.23 147.161 111.77 146 109z"/>
<path fill="currentColor" d="M40 110L40 116C40.9511 113.715 40.9511 112.285 40 110z"/>
<path fill="currentColor" d="M41 110L41 117C42.0595 114.466 42.0595 112.534 41 110z"/>
<path fill="currentColor" d="M147 110L147 117C148.059 114.466 148.059 112.534 147 110z"/>
<path fill="currentColor" d="M40 116L41 117L40 116z"/>
<path fill="currentColor" d="M39 117L40 118L39 117z"/>
<path fill="currentColor" d="M148 117L148 121C148.71 119.241 148.71 118.759 148 117z"/>
<path fill="currentColor" d="M38 118L39 119L38 118z"/>
<path fill="currentColor" d="M37 120L38 121L37 120z"/>
<path fill="currentColor" d="M36 121L37 122L36 121z"/>
<path fill="currentColor" d="M148 121L148 124C148.696 122.446 148.696 122.554 148 121z"/>
<path fill="currentColor" d="M36 122L37 123L36 122z"/>
<path fill="currentColor" d="M35 123L36 124L35 123z"/>
<path fill="currentColor" d="M35 124L36 125L35 124z"/>
<path fill="currentColor" d="M148 124L148 127C148.696 125.446 148.696 125.554 148 124z"/>
<path fill="currentColor" d="M149 124L149 141C150.883 136.514 150.883 128.486 149 124z"/>
<path fill="currentColor" d="M34 125L34 136C35.4309 132.59 35.4309 128.41 34 125z"/>
<path fill="currentColor" d="M35 125L35 136C36.4309 132.59 36.4309 128.41 35 125z"/>
<path fill="currentColor" d="M148 127C148 131.321 147.53 135.727 148 140C149.591 136.209 149.591 130.791 148 127z"/>
<path fill="currentColor" d="M83.3333 131.667C83.2778 131.722 83.2222 132.778 83.6667 132.333C83.7222 132.278 83.7778 131.222 83.3333 131.667z"/>
<path fill="currentColor" d="M84.3333 131.667C84.2778 131.722 84.2222 132.778 84.6667 132.333C84.7222 132.278 84.7778 131.222 84.3333 131.667z"/>
<path fill="currentColor" d="M86 131L85 137C87.3581 137.659 88.2432 138.267 90 140L96 138L96 131L86 131z"/>
<path fill="currentColor" d="M96 131L96 134C96.6961 132.446 96.6961 132.554 96 131z"/>
<path fill="currentColor" d="M97 131L96 136C98.729 136.81 101.15 136.979 104 137C101.948 136.126 100.253 136.047 98 136C97.9124 134.036 97.7789 132.769 97 131z"/>
<path fill="currentColor" d="M98 131L98 136L104 136C102.231 135.221 100.964 135.088 99 135C98.8259 133.315 98.683 132.506 98 131z"/>
<path fill="currentColor" d="M83.3333 133.667C83.2778 133.722 83.2222 134.778 83.6667 134.333C83.7222 134.278 83.7778 133.222 83.3333 133.667z"/>
<path fill="currentColor" d="M84.3333 133.667C84.2778 133.722 84.2222 134.778 84.6667 134.333C84.7222 134.278 84.7778 133.222 84.3333 133.667z"/>
<path fill="currentColor" d="M85 133L86 134L85 133z"/>
<path fill="currentColor" d="M46.6667 134.333C46.2222 134.778 47.2778 134.722 47.3333 134.667C47.7778 134.222 46.7222 134.278 46.6667 134.333z"/>
<path fill="currentColor" d="M48 134C51.1633 135.327 54.5856 135 58 135C54.8367 133.673 51.4144 134 48 134z"/>
<path fill="currentColor" d="M58 134C60.8897 135.213 63.8741 134.998 67 135C64.1103 133.787 61.1259 134.002 58 134z"/>
<path fill="currentColor" d="M85 134L86 135L85 134z"/>
<path fill="currentColor" d="M40 135C41.2484 135.685 41.5484 135.749 43 136C41.7517 135.315 41.4516 135.251 40 135z"/>
<path fill="currentColor" d="M43.6667 135.333C43.2222 135.778 44.2778 135.722 44.3333 135.667C44.7778 135.222 43.7222 135.278 43.6667 135.333z"/>
<path fill="currentColor" d="M48 135C51.1633 136.327 54.5856 136 58 136C54.8367 134.673 51.4144 135 48 135z"/>
<path fill="currentColor" d="M58 135C60.8897 136.213 63.8741 135.998 67 136C64.1103 134.787 61.1259 135.002 58 135z"/>
<path fill="currentColor" d="M67 135C69.8897 136.213 72.8741 135.998 76 136C73.1103 134.787 70.1259 135.002 67 135z"/>
<path fill="currentColor" d="M76 135C78.3315 135.985 80.4567 135.981 83 136C80.6684 135.015 78.5434 135.019 76 135z"/>
<path fill="currentColor" d="M83 135L84 136L83 135z"/>
<path fill="currentColor" d="M84.3333 135.667C84.2778 135.722 84.2222 136.778 84.6667 136.333C84.7222 136.278 84.7778 135.222 84.3333 135.667z"/>
<path fill="currentColor" d="M35 136L36 137L35 136z"/>
<path fill="currentColor" d="M36.6667 136.333C36.2222 136.778 37.2778 136.722 37.3333 136.667C37.7778 136.222 36.7222 136.278 36.6667 136.333z"/>
<path fill="currentColor" d="M38.6667 136.333C38.2222 136.778 39.2778 136.722 39.3333 136.667C39.7778 136.222 38.7222 136.278 38.6667 136.333z"/>
<path fill="currentColor" d="M40.6667 136.333C40.2222 136.778 41.2778 136.722 41.3333 136.667C41.7778 136.222 40.7222 136.278 40.6667 136.333z"/>
<path fill="currentColor" d="M96 136L97 137L96 136z"/>
<path fill="currentColor" d="M104 136C106.89 137.213 109.874 136.998 113 137C110.11 135.787 107.126 136.002 104 136z"/>
<path fill="currentColor" d="M113 136C116.163 137.327 119.586 137 123 137C119.837 135.673 116.414 136 113 136z"/>
<path fill="currentColor" d="M123 136C125.89 137.213 128.874 136.998 132 137C129.11 135.787 126.126 136.002 123 136z"/>
<path fill="currentColor" d="M132 136C134.89 137.213 137.874 136.998 141 137C138.11 135.787 135.126 136.002 132 136z"/>
<path fill="currentColor" d="M35 137C36.2484 137.685 36.5484 137.749 38 138C36.7516 137.315 36.4516 137.251 35 137z"/>
<path fill="currentColor" d="M85 137C86.5061 137.683 87.3148 137.826 89 138C87.494 137.317 86.6852 137.174 85 137z"/>
<path fill="currentColor" d="M96 137L97 138L96 137z"/>
<path fill="currentColor" d="M113 137C116.163 138.327 119.586 138 123 138C119.837 136.673 116.414 137 113 137z"/>
<path fill="currentColor" d="M123 137C125.89 138.213 128.874 137.998 132 138C129.11 136.787 126.126 137.002 123 137z"/>
<path fill="currentColor" d="M132 137C134.89 138.213 137.874 137.998 141 138C138.11 136.787 135.126 137.002 132 137z"/>
<path fill="currentColor" d="M141 137C142.769 137.779 144.036 137.912 146 138C144.231 137.221 142.964 137.088 141 137z"/>
<path fill="currentColor" d="M146 137L147 138L146 137z"/>
<path fill="currentColor" d="M70 138C71.2484 138.685 71.5484 138.749 73 139C71.7516 138.315 71.4516 138.251 70 138z"/>
<path fill="currentColor" d="M73 138C74.2484 138.685 74.5484 138.749 76 139C74.7516 138.315 74.4516 138.251 73 138z"/>
<path fill="currentColor" d="M73 139C76.6115 140.512 80.2294 139.7 84 139C80.3885 137.488 76.7706 138.3 73 139z"/>
<path fill="currentColor" d="M88 138L89 139L88 138z"/>
<path fill="currentColor" d="M92.3333 138.667C92.2778 138.722 92.2222 139.778 92.6667 139.333C92.7222 139.278 92.7778 138.222 92.3333 138.667z"/>
<path fill="currentColor" d="M93 138C94.2484 138.685 94.5484 138.749 96 139C94.7517 138.315 94.4516 138.251 93 138z"/>
<path fill="currentColor" d="M81 139C83.0521 139.874 84.7472 139.953 87 140C84.9479 139.126 83.2528 139.047 81 139z"/>
<path fill="currentColor" d="M87 139C88.2484 139.685 88.5484 139.749 90 140C88.7516 139.315 88.4516 139.251 87 139z"/>
<path fill="currentColor" d="M93 139C95.6127 140.098 98.1645 139.993 101 140C98.3873 138.902 95.8355 139.007 93 139z"/>
<path fill="currentColor" d="M101 139C103.332 139.985 105.457 139.981 108 140C105.668 139.015 103.543 139.019 101 139z"/>
<path fill="currentColor" d="M103 140C105.613 141.098 108.165 140.993 111 141C108.362 139.491 106.016 139.831 103 140z"/>
<path fill="currentColor" d="M109 139C110.139 140.015 110.612 140.309 112 141C111.02 139.217 111.092 139.406 109 139z"/>
<path fill="currentColor" d="M147 139L148 140L147 139z"/>
<path fill="currentColor" d="M90.3333 140.667C90.2778 140.722 90.2222 141.778 90.6667 141.333C90.7222 141.278 90.7778 140.222 90.3333 140.667z"/>
<path fill="currentColor" d="M91.3333 140.667C91.2778 140.722 91.2222 141.778 91.6667 141.333C91.7222 141.278 91.7778 140.222 91.3333 140.667z"/>
<path fill="currentColor" d="M96 140C98.3315 140.985 100.457 140.981 103 141C100.668 140.015 98.5434 140.019 96 140z"/>
<path fill="currentColor" d="M148 140L149 141L148 140z"/>
</svg>`;
    const html = `
      <div style="width:${sizePx}px;height:${sizePx}px;display:flex;align-items:center;justify-content:center;transform: rotate(${heading}deg); transform-origin:50% 50%; color:#000000; ${glow}">
        <div style="width:${Math.round(sizePx*0.95)}px;height:${Math.round(sizePx*0.95)}px;">${svg}</div>
      </div>`;
    return L.divIcon({ className:"", html, iconSize:[sizePx,sizePx], iconAnchor:[sizePx/2, sizePx/2] });
  }
  // default: circle
  const circle = `
    <div style="
      width:${sizePx}px;height:${sizePx}px;border-radius:50%;
      border:2px solid rgba(0,0,0,0.45);
      background:${state.iconColor};
      ${state.glow ? "box-shadow: 0 0 14px 4px rgba(255,255,255,0.35);" : ""}
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:${Math.max(10, Math.floor(sizePx*0.42))}px;
      color:#000;
    ">‚Ä¢</div>`;
  return L.divIcon({ className:"", html: circle, iconSize:[sizePx,sizePx], iconAnchor:[sizePx/2, sizePx/2] });
}


function makeLabelHtml(t){
  const show = state.labelsOn;
  if(!show) return "";
  const name = (t.name?.trim() ? t.name.trim() : t.type);
  const count = Number(t.count||1);
  const txt = count>1 ? `${name} √ó${count}` : name;

  const bg = state.labelBgOn ? `background:${hexToRgba(state.labelBg, 0.55)}; padding:2px 6px; border-radius:10px; border:1px solid rgba(255,255,255,0.12);` : "";
  return `<div style="
      color:${state.labelColor};
      font-weight:900;
      font-size:${state.labelSize}px;
      white-space:nowrap;
      ${bg}
    ">${escapeHtml(txt)}</div>`;
}

function hexToRgba(hex, a){
  const h = hex.replace("#","");
  const r = parseInt(h.substring(0,2),16);
  const g = parseInt(h.substring(2,4),16);
  const b = parseInt(h.substring(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}
function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function dynIconSize(){
  const base = Number(state.iconSize||30);
  if(!state.dynSize) return base;
  const z = map.getZoom();
  // map zoom 5..12 typical => 0.75..1.35
  const k = clamp(0.55 + (z/12), 0.75, 1.35);
  return Math.round(base * k);
}

// Threat sector drawing (circle sector as polygon)
function sectorPolygon(lat,lng, radiusKm, headingDeg, angleDeg, steps=40){
  const r = kmToMeters(radiusKm);
  const half = angleDeg/2;
  const pts = [];
  pts.push([lat,lng]);
  for(let i=0;i<=steps;i++){
    const b = headingDeg - half + (angleDeg*(i/steps));
    const p = destinationPoint(lat,lng, b, r);
    pts.push([p.lat,p.lng]);
  }
  pts.push([lat,lng]);
  return pts;
}

function addTargetLayers(t){
  const size = dynIconSize();
  const marker = L.marker([t.lat,t.lng], { draggable:true, icon: makeIconForTarget(t, size) }).addTo(map);

  const label = L.marker([t.lat,t.lng], {
    interactive:false,
    icon: L.divIcon({ className:"", html: makeLabelHtml(t), iconAnchor:[-10, -10] })
  }).addTo(map);

  const idLabel = L.marker([t.lat,t.lng], {
    interactive:false,
    icon: L.divIcon({ className:"", html: "", iconAnchor:[-10, 22] })
  }).addTo(map);

  const dirEnd = destinationPoint(t.lat, t.lng, t.heading ?? 90, kmToMeters(35));
  const dirLine = L.polyline([[t.lat,t.lng],[dirEnd.lat,dirEnd.lng]], { weight:3, opacity:0.85 }).addTo(map);

  const traj = L.polyline([], { weight: state.trajWidth, opacity: state.trajOpacity }).addTo(map);
  const turnPoints = L.layerGroup().addTo(map);

  const threatSector = L.polygon(sectorPolygon(t.lat,t.lng, t.threatRadius||0, t.heading||0, t.threatAngle||90), {
    weight:1,
    opacity:0.35,
    fillOpacity:0.12
  }).addTo(map);

  layersById.set(String(t.id), { marker, label, dirLine, traj, turnPoints, threatSector, idLabel });

  marker.on("drag", (ev) => {
    const ll = ev.target.getLatLng();
    t.lat = ll.lat; t.lng = ll.lng;
    refreshTarget(t);
    save();
    renderList();
  });

  marker.on("click", () => openTargetMenu(t));

  refreshTarget(t);
}

function refreshTarget(t){
  const ls = layersById.get(String(t.id));
  if(!ls) return;

  // icon size and color
  ls.marker.setIcon(makeIconForTarget(t, dynIconSize()));

  // label & id label
  ls.label.setIcon(L.divIcon({ className:"", html: makeLabelHtml(t), iconAnchor:[-10, -10] }));

  const idHtml = state.showId ? `<div style="color:${state.idColor}; font-weight:1000; font-size:${state.idSize}px; ${state.labelBgOn ? "background:rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.10); padding:1px 6px; border-radius:999px;" : ""}">${escapeHtml(t._idText||"")}</div>` : "";
  ls.idLabel.setIcon(L.divIcon({ className:"", html: idHtml, iconAnchor:[-10, 22] }));

  // move labels with marker
  const ll = ls.marker.getLatLng();
  ls.label.setLatLng(ll);
  ls.idLabel.setLatLng(ll);

  // direction line
  if(state.dirLineOn){
    const end = destinationPoint(t.lat, t.lng, t.heading ?? 0, kmToMeters(35));
    ls.dirLine.setLatLngs([[t.lat,t.lng],[end.lat,end.lng]]);
    ls.dirLine.setStyle({ opacity: 0.85 });
  } else {
    ls.dirLine.setStyle({ opacity: 0 });
  }

  // trajectory
  if(state.trajOn){
    const latlngs = (t.trajectory||[]).map(p => [p.lat,p.lng]);
    ls.traj.setLatLngs(latlngs);
    const dash = state.trajStyle==="dash" ? "8 8" : null;
    ls.traj.setStyle({
      color: state.trajColor,
      weight: Number(state.trajWidth||3),
      opacity: Number(state.trajOpacity||0.9),
      dashArray: dash
    });
  } else {
    ls.traj.setLatLngs([]);
  }

  // turn points
  ls.turnPoints.clearLayers();
  if(state.showTurnPoints && (t.points||[]).length){
    for(const p of t.points){
      L.circleMarker([p.lat,p.lng], { radius:4, weight:1, fillOpacity:0.7 }).addTo(ls.turnPoints);
    }
  }

  // threat sector
  const status = t.status;
  const col = (status==="threat" || status==="acousticThreat") ? "#ff4d4d" :
              (status==="acoustic") ? "#6fe3ff" :
              (status==="stop") ? "#ffd54a" : "#49d17d";

  if(state.hideThreats || (t.threatRadius||0)<=0){
    ls.threatSector.setStyle({ opacity:0, fillOpacity:0 });
  } else {
    ls.threatSector.setLatLngs(sectorPolygon(t.lat,t.lng, t.threatRadius||0, t.heading||0, t.threatAngle||90));
    ls.threatSector.setStyle({ color: col, fillColor: col, opacity: 0.35, fillOpacity: 0.12 });
  }

  // popup
  const title = (t.name?.trim() ? t.name.trim() : t.type);
  const pausedTxt = t.paused ? " (–ø–∞—É–∑–∞)" : "";
  ls.marker.bindPopup(`
    <div style="min-width:210px">
      <div style="font-weight:1000;margin-bottom:4px">${escapeHtml(title)}${pausedTxt}</div>
      <div style="font-size:12px;opacity:.85">–°—Ç–∞—Ç—É—Å: ${statusText(t.status)}</div>
      <div style="font-size:12px;opacity:.85">–ö—É—Ä—Å: ${t.heading ?? 0}¬∞ ‚Ä¢ –®–≤–∏–¥–∫: ${t.speed ?? 0} –∫–º/–≥–æ–¥</div>
      <div style="font-size:12px;opacity:.85">–ó–∞–≥—Ä–æ–∑–∞: R ${t.threatRadius ?? 0} –∫–º ‚Ä¢ ${t.threatAngle ?? 0}¬∞</div>
      <div style="font-size:12px;opacity:.75">–¢–∞–ø –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Üí –º–µ–Ω—é</div>
    </div>
  `);
}

// --- Context menu (simple modal-like prompt) ---
function openTargetMenu(t){
  // On iOS prompt is easiest + reliable.
  // Actions: pause/resume, edit, set direction, teleport, add turn point, clone, delete
  const pausedLabel = t.paused ? "‚ñ∂Ô∏è –ó–Ω—è—Ç–∏ –∑ –ø–∞—É–∑–∏" : "‚è∏ –ü–æ—Å—Ç–∞–≤–∏—Ç–∏ –Ω–∞ –ø–∞—É–∑—É";
  const choice = prompt(
`–î—ñ—è –¥–ª—è —Ü—ñ–ª—ñ:
1) ${pausedLabel}
2) ‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
3) ‚û°Ô∏è –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –Ω–æ–≤–∏–π –Ω–∞–ø—Ä—è–º–æ–∫ (–∫–ª—ñ–∫ –ø–æ –º–∞–ø—ñ)
4) üìç –î–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É –ø–æ–≤–æ—Ä–æ—Ç—É (–∫–ª—ñ–∫ –ø–æ –º–∞–ø—ñ)
5) üåÄ –¢–µ–ª–µ–ø–æ—Ä—Ç (—á–∞—Å/–≤—ñ–¥—Å—Ç–∞–Ω—å)
6) üß¨ –ö–ª–æ–Ω—É–≤–∞—Ç–∏
7) üóë –í–∏–¥–∞–ª–∏—Ç–∏

–í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä (1-7):`
  );
  if(!choice) return;
  const n = Number(choice);
  if(n===1){
    t.paused = !t.paused;
    save(); renderList(); refreshTarget(t);
    return;
  }
  if(n===2){
    editTarget(t);
    return;
  }
  if(n===3){
    startSetDirection(t);
    return;
  }
  if(n===4){
    startAddTurnPoint(t);
    return;
  }
  if(n===5){
    teleportTarget(t);
    return;
  }
  if(n===6){
    cloneTarget(t);
    return;
  }
  if(n===7){
    deleteTarget(t);
    return;
  }
}

function editTarget(t){
  // load UI fields and apply
  $("type").value = t.type || "–®–∞—Ö–µ–¥";
  $("status").value = t.status || "move";
  $("name").value = t.name || "";
  $("count").value = t.count || 1;
  $("speed").value = t.speed ?? 150;
  $("rangeKm").value = t.rangeKm ?? 999;
  $("heading").value = t.heading ?? 90;
  $("threatRadius").value = t.threatRadius ?? 25;
  $("threatAngle").value = t.threatAngle ?? 90;

  alert("–ü–æ–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –≤ –ø–∞–Ω–µ–ª—å. –ó–º—ñ–Ω–∏ –∑–Ω–∞—á–µ–Ω–Ω—è —ñ –Ω–∞—Ç–∏—Å–Ω–∏ '–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –¥–æ –≤–∏–±—Ä–∞–Ω–æ—ó' —É —Å–ø–∏—Å–∫—É (–∫–Ω–æ–ø–∫–∞ –∑–Ω–∏–∑—É –≤ –∫–∞—Ä—Ç–æ—á—Ü—ñ —Ü—ñ–ª—ñ).");
}

// Add direction by map click
let pendingAction = null; // {type, targetId}
function startSetDirection(t){
  pendingAction = { type:"setDirection", targetId:t.id };
  alert("–ö–ª—ñ–∫–Ω–∏ –Ω–∞ –º–∞–ø—ñ, —â–æ–± –∑–∞–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –Ω–∞–ø—Ä—è–º–æ–∫.");
}
function startAddTurnPoint(t){
  pendingAction = { type:"addTurnPoint", targetId:t.id };
  alert("–ö–ª—ñ–∫–Ω–∏ –Ω–∞ –º–∞–ø—ñ, —â–æ–± –¥–æ–¥–∞—Ç–∏ —Ç–æ—á–∫—É –ø–æ–≤–æ—Ä–æ—Ç—É.");
}
map.on("click", (e) => {
  if(state.addMode){
    createTargetAt(e.latlng);
    return;
  }
  if(!pendingAction) return;
  const t = data.targets.find(x => x.id === pendingAction.targetId);
  if(!t){ pendingAction=null; return; }

  if(pendingAction.type==="setDirection"){
    const br = bearing(t.lat,t.lng, e.latlng.lat, e.latlng.lng);
    t.heading = Math.round((br+360)%360);
    pendingAction = null;
    refreshTarget(t); save(); renderList();
    return;
  }
  if(pendingAction.type==="addTurnPoint"){
    t.points = t.points || [];
    t.points.push({ lat: e.latlng.lat, lng: e.latlng.lng });
    pendingAction = null;
    refreshTarget(t); save(); renderList();
    return;
  }
});

function bearing(lat1,lng1,lat2,lng2){
  const œÜ1 = deg2rad(lat1), œÜ2=deg2rad(lat2);
  const ŒîŒª = deg2rad(lng2-lng1);
  const y = Math.sin(ŒîŒª)*Math.cos(œÜ2);
  const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
  return rad2deg(Math.atan2(y,x));
}

function teleportTarget(t){
  const mode = prompt("–¢–µ–ª–µ–ø–æ—Ä—Ç: –≤–≤–µ–¥–∏ 't' (–∑–∞ —á–∞—Å–æ–º) –∞–±–æ 'd' (–∑–∞ –≤—ñ–¥—Å—Ç–∞–Ω–Ω—é):", "t");
  if(!mode) return;

  if(mode.toLowerCase()==="t"){
    const min = Number(prompt("–•–≤–∏–ª–∏–Ω–∏:", "1")||"0");
    const sec = Number(prompt("–°–µ–∫—É–Ω–¥–∏:", "0")||"0");
    const totalH = (min*60+sec)/3600;
    const speed = Number(t.speed||0);
    const km = speed * totalH;
    const p = destinationPoint(t.lat,t.lng, t.heading||0, kmToMeters(km));
    t.lat = p.lat; t.lng = p.lng;
  } else {
    const km = Number(prompt("–ö—ñ–ª–æ–º–µ—Ç—Ä–∏:", "0")||"0");
    const m  = Number(prompt("–ú–µ—Ç—Ä–∏:", "0")||"0");
    const distM = kmToMeters(km) + m;
    const p = destinationPoint(t.lat,t.lng, t.heading||0, distM);
    t.lat = p.lat; t.lng = p.lng;
  }

  // mode after teleport
  const after = prompt("–†–µ–∂–∏–º –ø—ñ—Å–ª—è —Ç–µ–ª–µ–ø–æ—Ä—Ç—É: 'move' –∞–±–æ 'stop'", t.status==="stop"?"stop":"move");
  if(after) t.status = after==="stop" ? "stop" : "move";

  // update marker position
  const ls = layersById.get(String(t.id));
  if(ls) ls.marker.setLatLng([t.lat,t.lng]);
  refreshTarget(t); save(); renderList();
  map.setView([t.lat,t.lng], Math.max(map.getZoom(), 8));
}

function cloneTarget(t){
  const c = JSON.parse(JSON.stringify(t));
  c.id = uid();
  c.createdAt = Date.now();
  c.lat = t.lat + 0.02;
  c.lng = t.lng + 0.02;
  data.targets.push(c);
  addTargetLayers(c);
  save(); renderList();
}

function deleteTarget(t){
  if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –æ–±'—î–∫—Ç?")) return;
  const idx = data.targets.findIndex(x => x.id === t.id);
  if(idx>=0) data.targets.splice(idx,1);
  const ls = layersById.get(String(t.id));
  if(ls){
    map.removeLayer(ls.marker);
    map.removeLayer(ls.label);
    map.removeLayer(ls.dirLine);
    map.removeLayer(ls.traj);
    map.removeLayer(ls.turnPoints);
    map.removeLayer(ls.threatSector);
    map.removeLayer(ls.idLabel);
    layersById.delete(t.id);
  }
  save(); renderList();
}

// --- Create target ---
function assignIdText(){
  let n;
  if(state.idMode==="seq"){
    n = state.seqNext++;
    if(n > Number(state.idTo||9999)) state.seqNext = Number(state.idFrom||1000);
  } else {
    const from = Number(state.idFrom||1000);
    const to = Number(state.idTo||9999);
    n = Math.floor(from + Math.random()*(to-from+1));
  }
  const suf = (state.idSuffix||"").trim();
  return suf ? `${n}${suf}` : `${n}`;
}

function createTargetAt(latlng){
  const t = {
    id: uid(),
    owner: state.filter==="mine" ? "mine" : "foreign",
    type: $("type").value,
    status: $("status").value,
    name: $("name").value,
    count: Number($("count").value||1),
    speed: Number($("speed").value||0),
    rangeKm: Number($("rangeKm").value||0),
    heading: Number($("heading").value||0),
    threatRadius: Number($("threatRadius").value||0),
    threatAngle: Number($("threatAngle").value||90),
    lat: latlng.lat,
    lng: latlng.lng,
    createdAt: Date.now(),
    paused: false,
    points: [],
    trajectory: [{ lat: latlng.lat, lng: latlng.lng, t: Date.now() }],
    _idText: assignIdText()
  };
  data.targets.push(t);
  addTargetLayers(t);
  save();
  renderList();
  state.addMode=false;
  $("btnAdd").classList.remove("active");
  $("btnAdd").textContent = "‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—ñ–ª—å";
}

// --- Trajectory update loop (approximation) ---
let tickHandle = null;
function setTick(){
  if(tickHandle) { clearInterval(tickHandle); tickHandle=null; }
  const rate = state.tickRate;
  if(rate==="smooth"){
    // 20 fps-ish; still uses interval
    tickHandle = setInterval(() => step(0.05), 50);
  } else {
    const sec = Number(rate||5);
    tickHandle = setInterval(() => step(sec), sec*1000);
  }
}
function step(dtSec){
  const now = Date.now();
  for(const t of data.targets){
    if(t.paused) continue;
    if(t.status==="stop") continue;
    if((t.speed||0)<=0) continue;

    // apply renderMode: skip every other tick in "50%" mode
    if(state.renderMode==="50" && Math.random()<0.5) continue;

    // movement
    const km = (t.speed||0) * (dtSec/3600) * timeMultiplier;
    const p = destinationPoint(t.lat,t.lng, t.heading||0, kmToMeters(km));

    t.lat = p.lat; t.lng = p.lng;

    // turning: if points exist, steer toward first point when close enough
    if((t.points||[]).length){
      const next = t.points[0];
      const dist = haversineKm(t.lat,t.lng,next.lat,next.lng);
      const br = bearing(t.lat,t.lng,next.lat,next.lng);
      t.heading = Math.round((br+360)%360);
      if(dist < 2){ // reached (2km)
        t.points.shift();
      }
    }

    t.trajectory = t.trajectory || [];
    t.trajectory.push({ lat:t.lat, lng:t.lng, t: now });
    // keep last 600 points
    if(t.trajectory.length>600) t.trajectory.splice(0, t.trajectory.length-600);

    const ls = layersById.get(String(t.id));
    if(ls) ls.marker.setLatLng([t.lat,t.lng]);
    refreshTarget(t);
  }
  save();
  renderList(false);
}
function haversineKm(lat1,lng1,lat2,lng2){
  const R = 6371;
  const dLat = deg2rad(lat2-lat1);
  const dLng = deg2rad(lng2-lng1);
  const a = Math.sin(dLat/2)**2 + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

// Speed tool (global multiplier like original ‚Äú–≥–ª–æ–±–∞–ª—å–Ω–∏–π –∫–æ–µ—Ñ. —á–∞—Å—É‚Äù)
let timeMultiplier = 1.0;

// --- List render ---
function renderList(scrollToTop=true){
  const list = $("list");
  const prevScroll = list.scrollTop;

  list.innerHTML = "";
  const filtered = data.targets
    .filter(t => state.onlyMine ? t.owner==="mine" : true)
    .filter(t => state.filter==="mine" ? t.owner==="mine" : t.owner==="foreign")
    .slice()
    .sort((a,b)=> b.createdAt - a.createdAt);

  if(!filtered.length){
    list.innerHTML = `<div class="hint">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î —Ü—ñ–ª–µ–π.</div>`;
    return;
  }

  for(const t of filtered){
    const title = (t.name?.trim()?t.name.trim():t.type);
    const dot = statusDot(t.status);
    const paused = t.paused ? " ‚Ä¢ –ø–∞—É–∑–∞" : "";
    const etaMin = estimateMinutes(t);

    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(title)}</div>
          <div class="hint">${escapeHtml(t.type)} ‚Ä¢ ${t.heading ?? 0}¬∞ ‚Ä¢ ${t.speed ?? 0} –∫–º/–≥–æ–¥ ‚Ä¢ ID: ${(t._idText||"--")}${paused}</div>
        </div>
        <span class="badge"><span class="dot ${dot}"></span>${statusText(t.status)} ‚Ä¢ ${etaMin}</span>
      </div>

      <div class="actions">
        <button class="btn small" data-act="show" data-id="${t.id}">–ü–æ–∫–∞–∑–∞—Ç–∏</button>
        <button class="btn small" data-act="apply" data-id="${t.id}">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑ –ø–∞–Ω–µ–ª—ñ</button>
        <button class="btn small" data-act="dir" data-id="${t.id}">–ù–∞–ø—Ä—è–º–æ–∫</button>
        <button class="btn small danger" data-act="del" data-id="${t.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
      </div>
    `;
    list.appendChild(el);
  }

  list.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      const t = data.targets.find(x=>String(x.id)===String(id));
      if(!t) return;

      if(act==="show"){
        map.setView([t.lat,t.lng], Math.max(map.getZoom(), 10));
        const ls = layersById.get(String(t.id));
        ls?.marker.openPopup();
      }
      if(act==="apply"){
        // Apply target values to the panel (not –Ω–∞–æ–±–æ—Ä–æ—Ç)
        $("type").value = t.type || "–®–∞—Ö–µ–¥";
        $("status").value = t.status || "move";
        $("name").value = t.name || "";
        $("count").value = (t.count ?? 1);
        $("speed").value = (t.speed ?? 0);
        $("rangeKm").value = (t.rangeKm ?? 0);
        $("heading").value = (t.heading ?? 0);
        $("threatRadius").value = (t.threatRadius ?? 0);
        $("threatAngle").value = (t.threatAngle ?? 90);
      }
      if(act==="dir"){
        startSetDirection(t);
      }
      if(act==="del"){
        deleteTarget(t);
      }
    });
  });

  if(!scrollToTop) list.scrollTop = prevScroll;
}

function estimateMinutes(t){
  // just a display like "0 —Ö–≤."
  if(t.status==="stop" || (t.speed||0)<=0) return "0 —Ö–≤.";
  // if has next point, estimate time to it
  if((t.points||[]).length){
    const p = t.points[0];
    const dKm = haversineKm(t.lat,t.lng,p.lat,p.lng);
    const h = dKm / (t.speed||1);
    const m = Math.round(h*60);
    return `${m} —Ö–≤.`;
  }
  return "‚Äî";
}

// --- Export/Import ---
function save(){
  const payload = { state, data };
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
}
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const payload = JSON.parse(raw);
    if(payload?.state) Object.assign(state, payload.state);
    if(payload?.data) data = payload.data;
  }catch(e){}
}
function exportJson(){
  const blob = new Blob([JSON.stringify({ state, data }, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ukraine_radar_local.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
async function importJson(file){
  const txt = await file.text();
  const obj = JSON.parse(txt);
  if(!obj?.data || !obj?.state) throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç");
  // clear existing layers
  for(const [id, ls] of layersById.entries()){
    map.removeLayer(ls.marker);
    map.removeLayer(ls.label);
    map.removeLayer(ls.dirLine);
    map.removeLayer(ls.traj);
    map.removeLayer(ls.turnPoints);
    map.removeLayer(ls.threatSector);
    map.removeLayer(ls.idLabel);
    layersById.delete(id);
  }
  Object.assign(state, obj.state);
  data = obj.data;
  // rebuild
  (data.targets||[]).forEach(t => addTargetLayers(t));
  applyStateToUI();
  save();
  renderList();
}

// --- Screenshot ---
async function takeScreenshot(){
  const canvas = await html2canvas($("mapWrap"), { useCORS:true, backgroundColor:null, scale: 1.5 });
  const url = canvas.toDataURL("image/png");
  $("shotImg").src = url;
  $("shotModal").style.display = "flex";
  $("btnSaveShot").onclick = () => {
    const a = document.createElement("a");
    a.href = url;
    a.download = "screenshot.png";
    a.click();
  };
}

// --- Forecast ---
function clearForecast(){
  if(forecastLayer){ map.removeLayer(forecastLayer); forecastLayer=null; }
}
function showForecast(){
  clearForecast();
  // forecast selected = nearest target to center
  if(!data.targets.length) return;
  const center = map.getCenter();
  let best = null, bestD=1e9;
  for(const t of data.targets){
    const d = haversineKm(center.lat, center.lng, t.lat, t.lng);
    if(d<bestD){ bestD=d; best=t; }
  }
  if(!best) return;

  const mins = Number(state.forecastMin||20);
  const speed = Number(best.speed||0);
  if(speed<=0) return;

  const pts = [];
  pts.push([best.lat,best.lng]);
  for(let m=1;m<=mins;m++){
    const km = speed * (m/60) * timeMultiplier;
    const p = destinationPoint(best.lat,best.lng, best.heading||0, kmToMeters(km));
    pts.push([p.lat,p.lng]);
  }
  forecastLayer = L.polyline(pts, { color:"#6fe3ff", weight:3, opacity:0.9, dashArray:"6 8" }).addTo(map);
  map.fitBounds(forecastLayer.getBounds(), { padding:[30,30] });
}

// --- Watermark ---
function drawWatermark(text, color, opacity, angleDeg, density, pos){
  const c = $("watermark");
  const ctx = c.getContext("2d");
  const wrap = $("mapWrap");
  c.width = wrap.clientWidth;
  c.height = wrap.clientHeight;

  ctx.clearRect(0,0,c.width,c.height);
  ctx.save();
  ctx.globalAlpha = opacity;

  const fontSize = 22;
  ctx.font = `700 ${fontSize}px system-ui, -apple-system, Segoe UI`;
  ctx.fillStyle = color;

  const stepX = 260 / density;
  const stepY = 160 / density;

  // position offset
  let ox = c.width/2, oy=c.height/2;
  if(pos==="tl"){ ox = 140; oy = 60; }
  if(pos==="tr"){ ox = c.width-140; oy = 60; }
  if(pos==="bl"){ ox = 140; oy = c.height-60; }
  if(pos==="br"){ ox = c.width-140; oy = c.height-60; }

  ctx.translate(ox,oy);
  ctx.rotate(deg2rad(angleDeg));
  ctx.translate(-ox,-oy);

  for(let y=-c.height; y<c.height*2; y+=stepY){
    for(let x=-c.width; x<c.width*2; x+=stepX){
      ctx.fillText(text, x, y);
    }
  }
  ctx.restore();
}

// --- Crosshair ---
function renderCrosshair(){
  const host = $("crosshair");
  host.innerHTML = "";
  if(!state.crosshairOn){ host.style.display="none"; return; }
  host.style.display="block";

  const size = Number(state.crosshairSize||60);
  const col = state.crosshairColor || "#fff";
  const op = Number(state.crosshairOpacity||0.7);
  const type = state.crosshairType || "1";

  let svg;
  if(type==="1"){
    svg = `<svg width="${size}" height="${size}" viewBox="0 0 100 100" style="opacity:${op}">
      <circle cx="50" cy="50" r="18" fill="none" stroke="${col}" stroke-width="3"/>
      <line x1="50" y1="2" x2="50" y2="28" stroke="${col}" stroke-width="3"/>
      <line x1="50" y1="72" x2="50" y2="98" stroke="${col}" stroke-width="3"/>
      <line x1="2" y1="50" x2="28" y2="50" stroke="${col}" stroke-width="3"/>
      <line x1="72" y1="50" x2="98" y2="50" stroke="${col}" stroke-width="3"/>
    </svg>`;
  } else if(type==="2"){
    svg = `<svg width="${size}" height="${size}" viewBox="0 0 100 100" style="opacity:${op}">
      <circle cx="50" cy="50" r="10" fill="${col}"/>
      <circle cx="50" cy="50" r="26" fill="none" stroke="${col}" stroke-width="2" stroke-dasharray="4 5"/>
      <line x1="50" y1="0" x2="50" y2="38" stroke="${col}" stroke-width="2"/>
      <line x1="50" y1="62" x2="50" y2="100" stroke="${col}" stroke-width="2"/>
    </svg>`;
  } else {
    svg = `<svg width="${size}" height="${size}" viewBox="0 0 100 100" style="opacity:${op}">
      <rect x="14" y="14" width="72" height="72" fill="none" stroke="${col}" stroke-width="2"/>
      <line x1="50" y1="14" x2="50" y2="86" stroke="${col}" stroke-width="2"/>
      <line x1="14" y1="50" x2="86" y2="50" stroke="${col}" stroke-width="2"/>
    </svg>`;
  }
  host.innerHTML = svg;
}

// --- UI wiring ---
function setTab(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
  $("tab-targets").style.display = (name==="targets") ? "block" : "none";
  $("tab-admin").style.display = (name==="admin") ? "block" : "none";
  $("tab-settings").style.display = (name==="settings") ? "block" : "none";
  $("tab-tools").style.display = (name==="tools") ? "block" : "none";
}
document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ()=>setTab(t.dataset.tab)));

$("btnAdd").addEventListener("click", ()=>{
  state.addMode = !state.addMode;
  $("btnAdd").classList.toggle("active", state.addMode);
  $("btnAdd").textContent = state.addMode ? "üü¢ –ö–ª—ñ–∫–Ω–∏ –Ω–∞ –º–∞–ø—É‚Ä¶" : "‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ü—ñ–ª—å";
});
$("btnCenter").addEventListener("click", ()=> map.setView([48.3794, 31.1656], 6));
$("btnClear").addEventListener("click", ()=> { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —Ü—ñ–ª—ñ?")) { data.targets=[]; save(); location.reload(); } });
$("btnClear2").addEventListener("click", ()=> { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —Ü—ñ–ª—ñ?")) { data.targets=[]; save(); location.reload(); } });
$("btnReload").addEventListener("click", ()=> location.reload());

$("filterMine").addEventListener("click", ()=>{
  state.filter="mine";
  $("filterMine").classList.add("active");
  $("filterForeign").classList.remove("active");
  renderList();
});
$("filterForeign").addEventListener("click", ()=>{
  state.filter="foreign";
  $("filterForeign").classList.add("active");
  $("filterMine").classList.remove("active");
  renderList();
});

$("btnExport").addEventListener("click", exportJson);
$("btnImport").addEventListener("click", ()=> $("file").click());
$("file").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{ await importJson(f); } catch(err){ alert("–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: " + err.message); }
  e.target.value="";
});

$("btnShot").addEventListener("click", takeScreenshot);
$("btnCloseShot").addEventListener("click", ()=> $("shotModal").style.display="none");
$("shotModal").addEventListener("click", (e)=> { if(e.target.id==="shotModal") $("shotModal").style.display="none"; });

$("btnForecastShow").addEventListener("click", showForecast);
$("btnForecastClear").addEventListener("click", clearForecast);

// switches helper
function bindSwitch(id, key, onChange){
  const el = $(id);
  const set = (v)=>{
    state[key] = v;
    el.classList.toggle("on", !!v);
    onChange?.(v);
    save();
  };
  el.addEventListener("click", ()=> set(!state[key]));
  el.classList.toggle("on", !!state[key]);
}
bindSwitch("swStatusIcons","showStatusIcons", ()=>{ /* only affects list badges; kept */ });
bindSwitch("swHideThreats","hideThreats", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swAnnounce","showAnnounce", (v)=> updateAnnounce());
bindSwitch("swTurnPoints","showTurnPoints", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swGlow","glow", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swDynSize","dynSize", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swLabelBg","labelBgOn", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swLabels","labelsOn", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swCrosshair","crosshairOn", ()=> renderCrosshair());
bindSwitch("swShowId","showId", ()=> data.targets.forEach(refreshTarget));

bindSwitch("swBorder","borderOn", async (v)=>{
  await ensureBorder();
  if(v) borderLayer.addTo(map); else map.removeLayer(borderLayer);
  rebuildMask();
});
bindSwitch("swOblast","oblastOn", async (v)=>{
  await ensureOblast();
  if(v){
    oblastLayer.addTo(map);
    hookOblastClicks();
    applyOblastStyles();
  } else {
    map.removeLayer(oblastLayer);
  }
});
bindSwitch("swRaion","raionOn", async (v)=>{
  await ensureRaion();
  if(v) raionLayer.addTo(map); else map.removeLayer(raionLayer);
});

// contour color pickers
["borderStroke","oblastStroke","raionStroke"].forEach((id)=>{
  const el = $(id);
  if(!el) return;
  el.addEventListener("input", ()=>{
    state[id] = el.value;
    if(id==="borderStroke" && borderLayer) borderLayer.setStyle(styleBorder);
    if(id==="oblastStroke" && oblastLayer) oblastLayer.setStyle(styleRegion);
    if(id==="raionStroke" && raionLayer) raionLayer.setStyle(styleRaion);
    save();
  });
});
bindSwitch("swMask","maskOn", async (v)=>{
  await ensureBorder();
  rebuildMask();
});

bindSwitch("swTraj","trajOn", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swDirLine","dirLineOn", ()=> data.targets.forEach(refreshTarget));
bindSwitch("swFps","fpsOn", (v)=> $("fps").style.display = v ? "block" : "none");

bindSwitch("swOnlyMine","onlyMine", (v)=>{ state.onlyMine=v; renderList(); });

bindSwitch("swAlarms","alarmsOn", ()=> refreshAlarms());
bindSwitch("swFront","frontOn", ()=> refreshFront());

$("announceText").addEventListener("input", (e)=>{ state.announceText = e.target.value; updateAnnounce(); save(); });

function updateAnnounce(){
  const a = $("announce");
  if(state.showAnnounce && (state.announceText||"").trim()){
    a.textContent = state.announceText.trim();
    a.style.display = "block";
  } else {
    a.style.display = "none";
  }
}

$("iconColor").addEventListener("input",(e)=>{ state.iconColor=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("iconSize").addEventListener("input",(e)=>{ state.iconSize=Number(e.target.value||30); data.targets.forEach(refreshTarget); save(); });
$("labelColor").addEventListener("input",(e)=>{ state.labelColor=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("labelBg").addEventListener("input",(e)=>{ state.labelBg=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("labelSize").addEventListener("input",(e)=>{ state.labelSize=Number(e.target.value||12); data.targets.forEach(refreshTarget); save(); });

$("crosshairType").addEventListener("change",(e)=>{ state.crosshairType=e.target.value; renderCrosshair(); save(); });
$("crosshairColor").addEventListener("input",(e)=>{ state.crosshairColor=e.target.value; renderCrosshair(); save(); });
$("crosshairSize").addEventListener("input",(e)=>{ state.crosshairSize=Number(e.target.value||60); renderCrosshair(); save(); });
$("crosshairOpacity").addEventListener("input",(e)=>{ state.crosshairOpacity=Number(e.target.value||0.7); renderCrosshair(); save(); });

$("idMode").addEventListener("change",(e)=>{ state.idMode=e.target.value; save(); });
$("idFrom").addEventListener("input",(e)=>{ state.idFrom=Number(e.target.value||1000); save(); });
$("idTo").addEventListener("input",(e)=>{ state.idTo=Number(e.target.value||9999); save(); });
$("idSuffix").addEventListener("input",(e)=>{ state.idSuffix=e.target.value; save(); });
$("idColor").addEventListener("input",(e)=>{ state.idColor=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("idSize").addEventListener("input",(e)=>{ state.idSize=Number(e.target.value||12); data.targets.forEach(refreshTarget); save(); });

$("baseLayer").addEventListener("change",(e)=>{ state.baseLayer=e.target.value; setBaseLayer(); save(); });
function setBaseLayer(){
  Object.values(baseLayers).forEach(l=> map.removeLayer(l));
  baseLayers[state.baseLayer]?.addTo(map);
}

$("trajStyle").addEventListener("change",(e)=>{ state.trajStyle=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("trajColor").addEventListener("input",(e)=>{ state.trajColor=e.target.value; data.targets.forEach(refreshTarget); save(); });
$("trajWidth").addEventListener("input",(e)=>{ state.trajWidth=Number(e.target.value||3); data.targets.forEach(refreshTarget); save(); });
$("trajOpacity").addEventListener("input",(e)=>{ state.trajOpacity=Number(e.target.value||0.9); data.targets.forEach(refreshTarget); save(); });
$("forecastMin").addEventListener("input",(e)=>{ state.forecastMin=Number(e.target.value||20); save(); });

$("tickRate").addEventListener("change",(e)=>{ state.tickRate=e.target.value; setTick(); save(); });
$("renderMode").addEventListener("change",(e)=>{ state.renderMode=e.target.value; save(); });

$("btnSpeed").addEventListener("click", ()=>{
  const v = Number(prompt("–ì–ª–æ–±–∞–ª—å–Ω–∏–π –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —á–∞—Å—É (0.5 - 2.0):", timeMultiplier.toFixed(2))||timeMultiplier);
  timeMultiplier = clamp(v, 0.5, 2.0);
  alert("–ì–æ—Ç–æ–≤–æ: √ó" + timeMultiplier.toFixed(2));
});

$("btnWatermark").addEventListener("click", ()=>{
  const text = prompt("–¢–µ–∫—Å—Ç –≤–æ–¥—è–Ω–æ–≥–æ –∑–Ω–∞–∫–∞:", "–¢–ï–ö–°–¢");
  if(!text){ $("watermark").style.display="none"; return; }
  const density = Number(prompt("–©—ñ–ª—å–Ω—ñ—Å—Ç—å (1..5):", "2")||"2");
  const col = prompt("–ö–æ–ª—ñ—Ä (hex, –Ω–∞–ø—Ä #ffffff):", "#ffffff") || "#ffffff";
  const op = Number(prompt("–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å (0..1):", "0.20")||"0.2");
  const angle = Number(prompt("–ö—É—Ç (¬∞):", "30")||"30");
  const pos = prompt("–ü–æ–∑–∏—Ü—ñ—è: center/tl/tr/bl/br", "center") || "center";
  drawWatermark(text, col, clamp(op,0,1), angle, clamp(density,1,5), pos);
  $("watermark").style.display="block";
});

$("btnStatic").addEventListener("click", ()=>{
  alert("–°—Ç–∞—Ç–∏—á–Ω—ñ –æ–±'—î–∫—Ç–∏ –Ω–∞ –æ—Ä–∏–≥—ñ–Ω–∞–ª—ñ: –ü–£ –®–∞—Ö–µ–¥—ñ–≤/–∞–µ—Ä–æ–¥—Ä–æ–º–∏/–º–æ—Ä—Å—å–∫—ñ –±–∞–∑–∏/–ü–£ –ë–∞–ª—ñ—Å—Ç–∏–∫–∏. –¢—É—Ç —ó—Ö –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ —è–∫ GeoJSON —á–µ—Ä–µ–∑ —ñ–º–ø–æ—Ä—Ç (—É –≤–∫–ª–∞–¥—Ü—ñ –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏: —Ñ—Ä–æ–Ω—Ç/—Ç—Ä–∏–≤–æ–≥–∏).");
});

// alarms/front (import)
$("alarmService").addEventListener("change",(e)=>{ state.alarmService=e.target.value; save(); });
$("uaKey").addEventListener("input",(e)=>{ state.uaKey=e.target.value; save(); });
$("alarmOpacity").addEventListener("input",(e)=>{ state.alarmOpacity=Number(e.target.value||0.10); refreshAlarms(); save(); });

$("btnAlarmImport").addEventListener("click", ()=> $("alarmFile").click());
$("alarmFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{ data.alarmsGeojson = JSON.parse(await f.text()); refreshAlarms(); save(); }
  catch(err){ alert("–ü–æ–º–∏–ª–∫–∞ GeoJSON: " + err.message); }
  e.target.value="";
});
$("btnAlarmClear").addEventListener("click", ()=>{ data.alarmsGeojson=null; refreshAlarms(); save(); });

$("btnFrontImport").addEventListener("click", ()=> $("frontFile").click());
$("frontFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  try{ data.frontGeojson = JSON.parse(await f.text()); refreshFront(); save(); }
  catch(err){ alert("–ü–æ–º–∏–ª–∫–∞ GeoJSON: " + err.message); }
  e.target.value="";
});
$("btnFrontClear").addEventListener("click", ()=>{ data.frontGeojson=null; refreshFront(); save(); });

$("frontLineColor").addEventListener("input",(e)=>{ state.frontLineColor=e.target.value; refreshFront(); save(); });
$("frontFillColor").addEventListener("input",(e)=>{ state.frontFillColor=e.target.value; refreshFront(); save(); });

// overlays layers
let alarmsLayer = null;
function refreshAlarms(){
  if(alarmsLayer){ map.removeLayer(alarmsLayer); alarmsLayer=null; }
  if(!state.alarmsOn) return;

  if(state.alarmService==="custom" && data.alarmsGeojson){
    alarmsLayer = L.geoJSON(data.alarmsGeojson, {
      style:{ color:"#ff4d4d", weight:1, fillColor:"#ff4d4d", fillOpacity: clamp(state.alarmOpacity,0,1) }
    }).addTo(map);
    return;
  }

  if(state.alarmService==="ukrainealarm"){
    // Official API requires a key (not shipped here). We'll attempt fetch if key provided.
    if(!(state.uaKey||"").trim()){
      alert("–ü–æ—Ç—Ä—ñ–±–µ–Ω UkraineAlarm API key.");
      return;
    }
    // Endpoint list exists in various libs/docs; actual access may be restricted by CORS.
    // We'll do a best-effort request and if it fails, tell user.
    fetch("https://api.ukrainealarm.com/api/v3/alerts", {
      headers: { "Authorization": state.uaKey.trim() }
    }).then(r=>r.json()).then(json=>{
      // This API returns alerts list, not polygons. User still needs polygons mapping.
      alert("–û—Ç—Ä–∏–º–∞–Ω–æ –¥–∞–Ω—ñ, –∞–ª–µ –¥–ª—è –≤—ñ–¥–º–∞–ª—é–≤–∞–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø–æ–ª—ñ–≥–æ–Ω–∏ —Ä–∞–π–æ–Ω—ñ–≤/–æ–±–ª–∞—Å—Ç–µ–π, –∑–≤'—è–∑–∞–Ω—ñ –∑ regionId. –¶–µ –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏, —è–∫—â–æ —Ç–∏ –¥–∞—Å–∏ —Ç–∞–±–ª–∏—Ü—é –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ ID‚Üî–ø–æ–ª—ñ–≥–æ–Ω.");
    }).catch(()=>{
      alert("–ù–µ –≤–∏–π—à–ª–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ UkraineAlarm (–º–æ–∂–µ –±–ª–æ–∫—É–≤–∞—Ç–∏—Å—è CORS —É –±—Ä–∞—É–∑–µ—Ä—ñ). –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π '–°–≤—ñ–π GeoJSON (—ñ–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–æ–º)'.");
    });
  }
}

let frontLayer = null;
function refreshFront(){
  if(frontLayer){ map.removeLayer(frontLayer); frontLayer=null; }
  if(!state.frontOn) return;
  if(!data.frontGeojson) return;
  frontLayer = L.geoJSON(data.frontGeojson, {
    style:{
      color: state.frontLineColor,
      weight: 2,
      fillColor: state.frontFillColor,
      fillOpacity: 0.12
    }
  }).addTo(map);
}

// oblast select
function populateOblastSelect(gj){
  const sel = $("oblastSelect");
  sel.innerHTML="";
  const names = new Set();
  for(const f of (gj.features||[])){
    const name = (f.properties?.name || f.properties?.region || f.properties?.NAME_1 || "").toString();
    if(name) names.add(name);
  }
  [...names].sort((a,b)=>a.localeCompare(b,"uk")).forEach(n=>{
    const o = document.createElement("option");
    o.value=n; o.textContent=n;
    sel.appendChild(o);
  });
  // apply current
  for(const opt of sel.options){
    opt.selected = state.highlightedOblasts.includes(opt.value);
  }
  sel.addEventListener("change", ()=>{
    state.highlightedOblasts = [...sel.selectedOptions].map(o=>o.value);
    if(oblastLayer) oblastLayer.setStyle(styleRegion);
    save();
  });
}
$("btnOblastReset").addEventListener("click", ()=>{
  state.highlightedOblasts = [];
  for(const opt of $("oblastSelect").options) opt.selected=false;
  if(oblastLayer) oblastLayer.setStyle(styleRegion);
  save();
});

// apply state to UI elements
function applyStateToUI(){
  $("announceText").value = state.announceText || "";
  $("iconColor").value = state.iconColor;
  $("iconSize").value = state.iconSize;
  $("labelColor").value = state.labelColor;
  $("labelBg").value = state.labelBg;
  $("labelSize").value = state.labelSize;

  $("crosshairType").value = state.crosshairType;
  $("crosshairColor").value = state.crosshairColor;
  $("crosshairSize").value = state.crosshairSize;
  $("crosshairOpacity").value = state.crosshairOpacity;

  $("idMode").value = state.idMode;
  $("idFrom").value = state.idFrom;
  $("idTo").value = state.idTo;
  $("idSuffix").value = state.idSuffix;
  $("idColor").value = state.idColor;
  $("idSize").value = state.idSize;

  $("baseLayer").value = state.baseLayer;
  $("trajStyle").value = state.trajStyle;
  if($("borderStroke")) $("borderStroke").value = state.borderStroke || "#ffffff";
  if($("oblastStroke")) $("oblastStroke").value = state.oblastStroke || "#ffffff";
  if($("raionStroke")) $("raionStroke").value = state.raionStroke || "#ffffff";
  $("trajColor").value = state.trajColor;
  $("trajWidth").value = state.trajWidth;
  $("trajOpacity").value = state.trajOpacity;
  $("forecastMin").value = state.forecastMin;

  $("tickRate").value = state.tickRate;
  $("renderMode").value = state.renderMode;

  $("alarmService").value = state.alarmService;
  $("uaKey").value = state.uaKey;
  $("alarmOpacity").value = state.alarmOpacity;

  $("frontLineColor").value = state.frontLineColor;
  $("frontFillColor").value = state.frontFillColor;

  // buttons
  $("filterMine").classList.toggle("active", state.filter==="mine");
  $("filterForeign").classList.toggle("active", state.filter==="foreign");
  updateAnnounce();
  renderCrosshair();
  setBaseLayer();
  $("fps").style.display = state.fpsOn ? "block" : "none";
}

// FPS counter
let fpsLast = performance.now(), fpsFrames=0;
function fpsLoop(){
  fpsFrames++;
  const now = performance.now();
  if(now - fpsLast >= 1000){
    const fps = Math.round((fpsFrames*1000)/(now-fpsLast));
    fpsLast = now; fpsFrames=0;
    if(state.fpsOn) $("fps").textContent = "FPS: " + fps;
  }
  requestAnimationFrame(fpsLoop);
}
requestAnimationFrame(fpsLoop);

// icon resize on zoom if dyn size
map.on("zoomend", ()=>{
  if(!state.dynSize) return;
  data.targets.forEach(refreshTarget);
});

// init load
load();
applyStateToUI();

(async ()=>{
  // border default
  if(state.borderOn){
    try{ await ensureBorder(); }catch(e){}
  }
  if(state.oblastOn){
    try{ await ensureOblast(); oblastLayer.addTo(map);
      hookOblastClicks();
      applyOblastStyles();
 }catch(e){}
  }
  if(state.raionOn){
    try{ await ensureRaion(); raionLayer.addTo(map); }catch(e){}
  }
  rebuildMask();
})();

// rebuild targets layers
(data.targets||[]).forEach(t => addTargetLayers(t));
renderList();
setTick();

// announce
updateAnnounce();

let isDark=false;
$("toggleMapTheme")?.addEventListener("click",()=>{
 if(!isDark){ if(typeof lightLayer!=="undefined") map.removeLayer(lightLayer); if(typeof darkLayer!=="undefined") darkLayer.addTo(map); $("toggleMapTheme").textContent="–°–≤—ñ—Ç–ª–∞ –º–∞–ø–∞"; }
 else{ if(typeof darkLayer!=="undefined") map.removeLayer(darkLayer); if(typeof lightLayer!=="undefined") lightLayer.addTo(map); $("toggleMapTheme").textContent="–¢–µ–º–Ω–∞ –º–∞–ø–∞<br><label><input type='checkbox' id='toggleShaft' checked> –ü–∞–ª–∫–∞ —à–∞—Ö–µ–¥–∞</label>"; }
 isDark=!isDark;
});


// === City search (Nominatim) ===
(function(){
  const inp = $("citySearch"), box = $("cityResults");
  if(!inp || !box) return;
  let tmr=null, lastQ="";
  const show = (items)=>{
    box.innerHTML = items.map(it=>`
      <div class="item" data-lat="${it.lat}" data-lon="${it.lon}">
        <b>${escapeHtml(it.name)}</b>
        <span class="small">${escapeHtml(it.desc||"")}</span>
      </div>`).join("");
    box.style.display = items.length ? "block" : "none";
  };
  inp.addEventListener("input", ()=>{
    const q = inp.value.trim();
    if(q===lastQ) return;
    lastQ=q;
    if(tmr) clearTimeout(tmr);
    if(!q){ box.style.display="none"; return; }
    tmr=setTimeout(async ()=>{
      try{
        const url = "https://nominatim.openstreetmap.org/search?format=json&limit=8&addressdetails=1&q="+encodeURIComponent(q+" –£–∫—Ä–∞—ó–Ω–∞");
        const r = await fetch(url, { headers: { "Accept-Language":"uk" } });
        const j = await r.json();
        const items = (j||[]).map(x=>({
          lat: x.lat, lon: x.lon,
          name: (x.display_name||"").split(",")[0],
          desc: x.display_name || ""
        }));
        show(items);
      }catch(e){
        show([{lat:"",lon:"",name:"–ù–µ–º–∞—î —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É / –ø–æ—à—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π",desc:""}]);
      }
    }, 350);
  });
  box.addEventListener("click", (e)=>{
    const el = e.target.closest(".item");
    if(!el) return;
    const lat = parseFloat(el.dataset.lat), lon = parseFloat(el.dataset.lon);
    if(!isFinite(lat)||!isFinite(lon)) return;
    map.setView([lat,lon], 11);
    box.style.display="none";
  });
})();

// === Oblast selection: dim unselected ===
function applyOblastStyles(){
  if(!oblastLayer) return;
  const sel = new Set((state.selOblasts||[]).map(s=>s.toLowerCase()));
  oblastLayer.eachLayer(l=>{
    const nm = (l.feature?.properties?.name || l.feature?.properties?.NAME_1 || l.feature?.properties?.NAME || "").toString();
    const key = nm.toLowerCase();
    const chosen = sel.size===0 || sel.has(key);
    l.setStyle({
      color: state.oblastStroke || "#00aaff",
      weight: 1.2,
      fillColor: chosen ? "#000000" : "#000000",
      fillOpacity: chosen ? 0.0 : 0.7,
      opacity: 0.95
    });
  });
}
function syncOblastSelectFromSet(){
  const el = $("oblastSelect"); if(!el) return;
  const want = new Set((state.selOblasts||[]).map(s=>s.toLowerCase()));
  for(const opt of el.options){
    opt.selected = want.has(opt.value.toLowerCase());
  }
}
$("oblastSelect")?.addEventListener("change", ()=>{
  const el = $("oblastSelect");
  state.selOblasts = [...el.selectedOptions].map(o=>o.value);
  save();
  applyOblastStyles();
});
$("btnOblastReset")?.addEventListener("click", ()=>{
  state.selOblasts = [];
  save();
  syncOblastSelectFromSet();
  applyOblastStyles();
});

// Hook oblast clicks to toggle selection (when layer loaded)
function hookOblastClicks(){
  if(!oblastLayer) return;
  oblastLayer.eachLayer(l=>{
    l.off("click");
    l.on("click", ()=>{
      const nm = (l.feature?.properties?.name || l.feature?.properties?.NAME_1 || l.feature?.properties?.NAME || "").toString();
      if(!nm) return;
      const cur = new Set((state.selOblasts||[]));
      if(cur.has(nm)) cur.delete(nm); else cur.add(nm);
      state.selOblasts = [...cur];
      save();
      syncOblastSelectFromSet();
      applyOblastStyles();
    });
  });
}

// === Points (avatar-style markers) ===
state.points = state.points || [];
let pointMode=false;
function pointIconHTML(p){
  const label = escapeHtml(p.name||"");
  const kind = p.iconKind || "M";
  let inner = "";
  if(kind==="img" && p.img){
    inner = `<img src="${escapeHtml(p.img)}" alt="">`;
  }else if(kind==="pin"){
    inner = `<div style="font-size:18px;">üìç</div>`;
  }else{
    const ch = (label.trim()[0] || "‚Ä¢").toUpperCase();
    inner = `<div style="font-weight:900;">${escapeHtml(ch)}</div>`;
  }
  return `<div style="display:flex;flex-direction:column;align-items:center;">
    <div class="avatarMarker">${inner}</div>
    <div class="avatarLabel">${label}</div>
  </div>`;
}
function renderPoints(){
  if(!window.pointsLayer){
    window.pointsLayer = L.layerGroup().addTo(map);
  }
  window.pointsLayer.clearLayers();
  for(const p of (state.points||[])){
    const icon = L.divIcon({ className:"", html: pointIconHTML(p), iconSize:[60,60], iconAnchor:[30,30] });
    const m = L.marker([p.lat,p.lng], { icon }).addTo(window.pointsLayer);
    m.on("contextmenu", ()=>{
      if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ—á–∫—É '"+(p.name||"")+"'?")){
        state.points = (state.points||[]).filter(x=>x.id!==p.id);
        save();
        renderPoints();
      }
    });
  }
}
$("ptMode")?.addEventListener("click", ()=>{
  pointMode = !pointMode;
  $("ptMode").textContent = "üìç –†–µ–∂–∏–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ—á–∫–∏: " + (pointMode?"–£–≤—ñ–º–∫":"–í–∏–º–∫");
});
$("ptClear")?.addEventListener("click", ()=>{
  if(confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ç–æ—á–∫–∏?")){
    state.points = [];
    save();
    renderPoints();
  }
});
document.querySelectorAll("[data-pt-example]")?.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $("ptName").value = btn.getAttribute("data-pt-example") || "";
  });
});
map.on("click", (e)=>{
  if(!pointMode) return;
  const name = ($("ptName")?.value || "").trim() || "–¢–æ—á–∫–∞";
  const iconKind = ($("ptIcon")?.value || "M");
  const img = ($("ptImg")?.value || "").trim();
  const p = { id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()), name, iconKind, img, lat:e.latlng.lat, lng:e.latlng.lng };
  state.points.push(p);
  save();
  renderPoints();
});
renderPoints();


// === Oblast toggles list (alphabet UA) ===
const OBLASTS_UA = [
  "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º",
  "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–õ—É–≥–∞–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–°—É–º—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–Ω—ñ–≤–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
  "–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å"
];
function normOblastName(n){
  n = (n||"").toString().trim();
  // unify common variants from geojson
  n = n.replace(/^–º\.\s*/i,"").replace(/\s+–æ–±–ª\.?$/i," –æ–±–ª–∞—Å—Ç—å");
  if(n.toLowerCase()==="–∫—Ä–∏–º" || n.toLowerCase().includes("–∫—Ä–∏–º")) return "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞ –†–µ—Å–ø—É–±–ª—ñ–∫–∞ –ö—Ä–∏–º";
  if(!/–æ–±–ª–∞—Å—Ç—å$/i.test(n) && !n.toLowerCase().includes("—Ä–µ—Å–ø—É–±–ª—ñ–∫–∞")) n += " –æ–±–ª–∞—Å—Ç—å";
  return n;
}
function renderOblastToggleList(){
  const box = $("oblastToggleList");
  if(!box) return;
  const sel = new Set((state.selOblasts||[]).map(normOblastName));
  box.innerHTML = OBLASTS_UA.map(name=>{
    const on = sel.size===0 ? false : sel.has(name);
    return `
      <div class="row" style="justify-content:space-between;gap:10px;">
        <div style="font-weight:700;">${escapeHtml(name)}</div>
        <div class="switch ${on?'on':''}" data-oblast="${escapeHtml(name)}"></div>
      </div>`;
  }).join("");
  box.querySelectorAll(".switch[data-oblast]").forEach(sw=>{
    sw.addEventListener("click", ()=>{
      const name = sw.getAttribute("data-oblast");
      const cur = new Set((state.selOblasts||[]).map(normOblastName));
      // if empty selection means "none selected" in UI; we will start selection set on first toggle
      if(cur.size===0){
        cur.add(name);
      } else {
        if(cur.has(name)) cur.delete(name); else cur.add(name);
      }
      state.selOblasts = [...cur];
      save();
      renderOblastToggleList();
      syncOblastSelectFromSet?.();
      applyOblastStyles?.();
    });
  });
}
$("oblastAll")?.addEventListener("click", ()=>{
  state.selOblasts = [...OBLASTS_UA];
  save(); renderOblastToggleList(); syncOblastSelectFromSet?.(); applyOblastStyles?.();
});
$("oblastNone")?.addEventListener("click", ()=>{
  state.selOblasts = [];
  save(); renderOblastToggleList(); syncOblastSelectFromSet?.(); applyOblastStyles?.();
});
// re-render when settings tab opened
document.querySelectorAll("[data-tab]")?.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    if(btn.getAttribute("data-tab")==="settings"){
      setTimeout(()=>renderOblastToggleList(), 50);
    }
  });
});

</script>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:9999;">
    <div style="width:min(560px,calc(100% - 24px));background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;">
      <div class="h" style="margin-bottom:6px;">–í—Ö—ñ–¥</div>
      <div class="muted">–©–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—å —Å–∞–π—Ç–æ–º, –≤–≤–µ–¥—ñ—Ç—å –≤–∞—à –∫–ª—é—á –¥–æ—Å—Ç—É–ø—É.</div>
      <div class="row" style="margin-top:12px;">
        <input id="authKey" class="input" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–ª—é—á‚Ä¶" style="flex:1;min-width:260px;" />
        <button class="btn ok" id="authLoginBtn">–£–≤—ñ–π—Ç–∏</button>
      </div>
      <div class="muted" id="authMsg" style="margin-top:10px;"></div>
      <div id="authBanned" style="display:none;margin-top:12px;">
        <div class="hr"></div>
        <div class="h2" style="color:var(--danger);">–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ</div>
        <div style="font-weight:800;margin-top:6px;">–í–∞—Å –±—É–ª–æ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏</div>
        <div class="muted" id="authBannedReason"></div>
      </div>
    </div>
  </div>

</body>
</html>